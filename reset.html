<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reset Password</title>
  <style>
    body {
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; margin: 0;
      background-image: url('/assets/iskolarbg.png');
      background-size: cover; background-position: center; background-repeat: no-repeat;
      font-family: Arial, Helvetica, sans-serif;
    }
    .container1 {
      width: 100%; max-width: 500px;
      background-image: linear-gradient(to right, rgba(146,59,59,0.6), rgba(255,255,255,0.6));
      border-radius: 20px; display: flex; justify-content: center; align-items: center;
      padding: 20px; margin: auto;
    }
    .container11 {
      width: 100%; max-width: 400px; background: #fff; border-radius: 20px;
      padding: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.25); text-align: center;
    }
    .container111 { display: flex; flex-direction: column; align-items: center; gap: 15px; }
    .logo { display: flex; justify-content: center; align-items: center; gap: 5px; }
    .logo img { height: 55px; width: auto; }
    h1 { margin: 10px 0; }
    p { font-size: 16px; margin: 0; }
    .textBox {
      width: 100%; margin-bottom: 15px; position: relative; border-radius: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .textBox input, .submitButton {
      width: 100%; height: 45px; font-size: 16px; border-radius: 20px; box-sizing: border-box;
    }
    .textBox input {
      border: 2px solid black; outline: none; padding: 0 12px; color: black;
    }
    .textBox label {
      position: absolute; top: 50%; left: 12px; transform: translateY(-50%);
      font-size: 16px; color: black; background-color: white; padding: 0 5px;
      pointer-events: none; transition: 0.3s;
    }
    .textBox input:focus ~ label, .textBox input:valid ~ label {
      top: 0; font-size: 12px; background-color: #fff;
    }
    .submitButton {
      border: none; background-color: #923B3B; color: white; cursor: pointer; margin-bottom: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-decoration: none; line-height: 45px; display: block; text-align: center;
    }
    .back-link {
      color: #923B3B; font-weight: bold; text-decoration: none; cursor: pointer; position: relative; display: inline-block;
    }
    .back-link::after {
      content: ""; position: absolute; bottom: 0; left: 0; height: 2px; width: 100%;
      background-color: #923B3B; transform: scaleX(0); transform-origin: left; transition: transform .3s ease-in-out;
    }
    .back-link:hover::after { transform: scaleX(1); }
    #msg { font-size: 14px; margin-top: 6px; min-height: 18px; }
    .hint { font-size: 14px; color: #444; }
    .disabled { opacity: .6; pointer-events: none; }
  </style>
</head>
<body>
  <div class="container1">
    <div class="container11">
      <div class="container111">
        <div class="logo">
          <img src="/assets/iskolarlink.png" alt="Iskolar Link Logo">
          <img src="/assets/iskologo.png" alt="Isko Logo">
          <img src="/assets/citylogo.png" alt="City Logo">
        </div>

        <h1>Reset Password</h1>
        <p class="hint">Enter your new password below.</p>

        <div class="textBox">
          <input type="password" id="pwd" required minlength="8" autocomplete="new-password" />
          <label>New password (min 8 chars)</label>
        </div>

        <div class="textBox">
          <input type="password" id="pwd2" required minlength="8" autocomplete="new-password" />
          <label>Confirm new password</label>
        </div>

        <a href="#" id="resetBtn" class="submitButton">Reset Password</a>
        <div id="msg"></div>

        <a class="back-link" href="/">Back to Login</a>
      </div>
    </div>
  </div>



<script>
  const params = new URLSearchParams(location.search);
  const userId = params.get("id");
  const token  = params.get("token");

  const resetBtn = document.getElementById("resetBtn");
  const p1 = document.getElementById("pwd");
  const p2 = document.getElementById("pwd2");
  const msg = document.getElementById("msg");

  // Disable form if link looks invalid
  if (!userId || !token) {
    msg.textContent = "Invalid reset link. Please request a new one.";
    resetBtn.classList.add("disabled");
  }

  resetBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    if (!userId || !token) return;

    const a = p1.value;
    const b = p2.value;

    if (!a || a.length < 8) {
      msg.textContent = "Password must be at least 8 characters.";
      return;
    }
    if (a !== b) {
      msg.textContent = "Passwords do not match.";
      return;
    }

    resetBtn.textContent = "Saving...";
    resetBtn.style.pointerEvents = "none";

    try {
      const res = await fetch("/auth/reset", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, token, password: a })
      });
      const data = await res.json().catch(() => ({}));
      msg.textContent = data.msg || (res.ok ? "Password reset." : "Unable to reset password.");
      if (res.ok) setTimeout(() => location.href = "/", 1200);
    } catch (err) {
      msg.textContent = "Something went wrong. Please try again.";
    } finally {
      resetBtn.textContent = "Reset Password";
      resetBtn.style.pointerEvents = "auto";
    }
  });

  async function precheck(){
    if (!userId || !token) {
      msg.textContent = "Invalid reset link. Please request a new one.";
      resetBtn.classList.add("disabled");
      return;
    }
    try {
      const res = await fetch(`/auth/reset/verify?id=${encodeURIComponent(userId)}&token=${encodeURIComponent(token)}`);
      const data = await res.json();
      if (!res.ok || !data.ok) {
        msg.textContent = "Invalid or expired reset link. Please request a new one.";
        resetBtn.classList.add("disabled");
      }
    } catch {
      // If verify fails (network), keep form enabled so user can still try
    }
  }

  document.addEventListener("DOMContentLoaded", precheck);
</script>
</body>
</html>
