<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Submit Document</title>
  <style>
    :root{
      --gold:#D4A017;   /* golden yellow */
      --maroon:#800000; /* maroon red */
      --maroon-dark:#5a0000;
    }

    * { box-sizing: border-box; }

    html, body { height: 100%; margin: 0; }

    body{
      min-height:100vh;
      display:flex;
      flex-direction:column;           /* header top, footer bottom */
      background-image:url('/assets/iskolarbg.png');
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      font-family:Arial, Helvetica, sans-serif;
      color:#333;
    }

    /* ========= HEADER ========= */
    .site-header{
      position:sticky; top:0; z-index:1000;
      background:var(--maroon);
      border-bottom:2px solid var(--maroon-dark);
    }
    .header-wrap{
      max-width:1200px;
      margin:0 auto;
      padding:10px 16px;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .header-center{
      display:flex;
      align-items:center;
      gap:18px;
    }
    .header-logo{
      height:64px; width:auto; flex:0 0 auto;
      filter:drop-shadow(0 1px 0 rgba(0,0,0,.1));
    }
    .brand-block{
      display:flex;
      flex-direction:column;
      align-items:center;
      line-height:1.15;
      text-align:center;
      color:#fff;
      user-select:none;
    }
    /* Main title link */
    .brand-block > a{
      color:#fff; text-decoration:none;
      font-weight:800; font-size:24px; letter-spacing:.5px;
      transition:color .25s ease;
    }
    .brand-block > a:hover{ color:var(--gold); }
    /* Subtext link */
    .brand-sub{ margin-top:4px; font-size:14px; font-weight:600; }
    .brand-sub a{
      color:#fff; text-decoration:none; transition:color .25s ease;
    }
    .brand-sub a:hover{ color:var(--gold); }

    @media (max-width:640px){
      .header-logo{height:48px}
      .brand-block > a{font-size:20px}
      .brand-sub{font-size:12px}
    }

    /* ========= MAIN LAYOUT ========= */
    main{
      flex:1;                           /* push footer to bottom */
      display:flex;
      justify-content:center;
      align-items:center;
      padding:40px 20px;
    }
    .page{
      display:flex;
      gap:30px;
      width:100%;
      max-width:1200px;
      align-items:flex-start;
      justify-content:center;
      flex-wrap:wrap; /* responsive stack on small screens */
    }

    .main{
      background-color:rgba(255,255,255,0.95);
      padding:30px;
      border-radius:40px;
      width:350px;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
      display:flex;
      flex-direction:column;
      gap:20px;
    }

    .main h2{
      text-align:center; color:black; margin-bottom:10px;
    }

    .category select{
      width:100%; padding:10px 12px;
      border:2px solid var(--maroon);
      border-radius:6px; font-size:14px; color:var(--maroon);
      background:#fff; cursor:pointer;
    }

    .file input[type="file"]{
      width:100%; padding:10px;
      border:2px dashed var(--maroon);
      border-radius:6px; background:#fff; color:var(--maroon);
    }
    .file input[type="file"]::file-selector-button{
      background:var(--maroon); color:#fff; border:none;
      padding:8px 15px; border-radius:6px; cursor:pointer;
      font-size:13px; font-weight:bold; transition:background .3s ease;
    }
    .file input[type="file"]::file-selector-button:hover{
      background:#a00000;
    }

    button{
      background:var(--maroon); color:#fff; padding:10px;
      border-radius:40px; border:none; width:100%; cursor:pointer; font-size:14px;
      transition:background .2s ease;
    }
    button:hover{ background:#a00000; }

    .main p{
      font-size:13px; line-height:1.5; color:#333;
      background:#f9f9f9; border-left:4px solid var(--maroon);
      padding:8px 12px; margin:5px 0; border-radius:6px;
    }

    .viewDocs{
      background:rgba(255,255,255,0.95);
      padding:20px; border-radius:40px;
      width:400px; height:500px;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
      overflow:auto;
    }
    .viewDocs h3{
      margin-bottom:15px; text-align:center; color:var(--maroon);
    }

    .folder{
      margin-bottom:10px; border:1px solid #ccc; border-radius:8px; overflow:hidden;
    }
    .folder-header{
      border:2px dotted var(--maroon); color:var(--maroon);
      padding:10px; cursor:pointer; font-weight:bold;
    }
    .folder-content{ display:none; padding:10px; background:#f9f9f9; }

    /* File rows */
    .docItem{
      position:relative;
      padding:10px 56px 10px 0; /* room for delete icon */
      border-bottom:1px solid #ddd;
    }
    .docItem:last-child{ border-bottom:none; }
    .docText{ margin:0; }
    .docCategory{ font-weight:bold; color:var(--maroon); }

    /* Delete icon button */
    .deleteBtn{
      position:absolute; top:6px; right:8px;
      width:36px; height:36px; display:inline-flex;
      align-items:center; justify-content:center;
      background:transparent; border-radius:8px;
      color:#b00020; opacity:.75; cursor:pointer; transition:.15s ease-in-out;
    }
    .deleteBtn:hover{ background:#fdecec; opacity:1; }
    .deleteBtn:focus-visible{ outline:2px solid #b00020; outline-offset:2px; }
    .deleteBtn svg{ width:24px; height:24px; display:block; }
    .deleteBtn[disabled]{ opacity:.35; cursor:not-allowed; background:transparent; }

    /* Status chips */
    .status{
      display:inline-block; margin-top:5px; padding:4px 8px;
      border-radius:6px; font-size:12px; font-weight:bold;
    }
    .status.pending{ background:#fff3cd; color:#856404; border:1px solid #ffeeba; }
    .status.accepted{ background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .status.rejected{ background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }

    /* Rejection reason */
    .rejectNote{ margin-top:6px; background:transparent; color:#7a0916; padding:6px 8px; border-radius:6px; font-size:12px; }
    .rejectNote strong{ color:#b00020; }

    /* Modal */
    .modal{
      display:none; position:fixed; z-index:2000; inset:0;
      background:rgba(0,0,0,.5);
    }
    .modal-content{
      background:#fff; margin:10% auto; padding:20px; border-radius:12px;
      width:500px; height:500px; overflow-y:auto; box-shadow:0 4px 10px rgba(0,0,0,.3);
    }
    .close{
      color:var(--maroon); float:right; font-size:28px; font-weight:bold; cursor:pointer;
    }
    .close:hover{ color:#a00000; }

    /* ========= FOOTER ========= */
    .site-footer{
      background:#fff;
      border-top:1px solid #000;
      outline:1px solid #000; outline-offset:-1px;
    }
    .footer-wrap{
      max-width:1200px; margin:0 auto; padding:14px 16px;
      display:flex; justify-content:center; align-items:center;
    }
    .footer-wrap img{ max-height:48px; width:auto; display:block; }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header class="site-header">
    <div class="header-wrap">
      <div class="header-center">
        <img class="header-logo" src="/assets/citylogo.png" alt="City of Koronadal Logo">
        <div class="brand-block">
          <a href="https://koronadal.gov.ph" target="_blank" rel="noopener noreferrer">
            CITY OF KORONADAL
          </a>
          <div class="brand-sub">
            <a href="https://www.facebook.com/profile.php?id=100093335296692" target="_blank" rel="noopener noreferrer">
              Iskolar ng Koronadal - Kabugwason Paglaum Program
            </a>
          </div>
        </div>
        <img class="header-logo" src="/assets/iskologo.png" alt="Isko-KPP Logo">
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main>
    <div class="page">
      <!-- Form Section -->
      <div class="main">
        <h2>Submit Document</h2>

        <div class="category">
          <select id="docType" required>
            <option value="" disabled selected>Select Document Type</option>
            <option value="Statement of Account">Statement of Account</option>
            <option value="Certificate of Registration">Certificate of Registration</option>
            <option value="Book Reimbursement">Book Reimbursement</option>
            <option value="Others">Others</option>
          </select>
        </div>

        <div class="file">
          <!-- accept PDF + images -->
          <input type="file" id="docFile" name="document" accept="application/pdf,image/*" required>
        </div>

        <p>When submitting documents, please ensure that the file type is <strong>.pdf ONLY</strong>, and the file name
          format: <strong>LastNameFirstName.pdf</strong>.</p>
        <p>For image files, the acceptable formats are <strong>.jpg and .png</strong>, with the file name in the format
          <strong>LastNameFirstName</strong>.
        </p>

        <button type="button" id="submitBtn">Submit</button>
      </div>

      <!-- Submitted Documents Section -->
      <div class="viewDocs">
        <h3>Submitted Documents</h3>
        <div id="docList"></div>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="footer-wrap">
      <img src="/assets/footer.png" alt="Footer Graphic">
    </div>
  </footer>

  <!-- Modal -->
  <div id="docModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modalTitle"></h2>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    // ---- Helpers: build GridFS URL and handle legacy filePath fallback
    function fileUrl(bucket, id, opts = { download: false }) {
      if (!bucket || !id) return null;
      return opts.download
        ? `/files/${bucket}/${id}/download`
        : `/files/${bucket}/${id}`;
    }
    function resolveDocUrl(doc) {
      // Prefer GridFS (bucket + fileId); fallback to legacy filePath
      return fileUrl(doc.bucket, doc.fileId) || doc.filePath || null;
    }

    // --- helper to read a rejection message from any likely field
    function getRejectReason(doc) {
      const r =
        (doc && (
          doc.rejectionReason ??
          doc.reason ??
          doc.rejectReason ??
          doc.rejection_note ??
          doc.rejectionMessage
        )) || '';
      return (typeof r === 'string') ? r.trim() : '';
    }

    // ---- Submit document
    document.getElementById('submitBtn').addEventListener('click', submitDocument);

    async function submitDocument() {
      const type = document.getElementById("docType").value;
      const fileInput = document.getElementById("docFile");
      const file = fileInput.files[0];

      if (!type || !file) {
        alert("Please select a document type and upload a file.");
        return;
      }

      // Optional client-side size check (10 MB)
      if (file.size > 10 * 1024 * 1024) {
        alert("File too large (max 10MB).");
        return;
      }

      const formData = new FormData();
      formData.append("docType", type);
      formData.append("document", file);

      try {
        const res = await fetch("/api/documents/me", {
          method: "POST",
          credentials: "include",
          body: formData
        });

        const data = await res.json();
        if (res.ok) {
          alert("✅ Document submitted!");
          fileInput.value = "";
          document.getElementById("docType").value = "";
          fetchDocuments(); // refresh list
        } else {
          alert("❌ " + (data.msg || "Submission failed."));
        }
      } catch (err) {
        alert("Error submitting document");
        console.error(err);
      }
    }

    // ---- Fetch and render user's documents grouped by category
    async function fetchDocuments() {
      try {
        const res = await fetch("/api/documents/me", {
          credentials: "include"
        });
        if (res.status === 401) {
          // not logged in / expired → go to login
          window.location.href = "/";
          return;
        }
        const docs = await res.json();

        const list = document.getElementById("docList");
        list.innerHTML = "";

        if (!Array.isArray(docs) || docs.length === 0) {
          list.innerHTML = "<p style='text-align:center; color:#555;'>No documents found.</p>";
          return;
        }

        const categories = [
          "Statement of Account",
          "Certificate of Registration",
          "Book Reimbursement",
          "Others"
        ];

        categories.forEach(category => {
          const folder = document.createElement("div");
          folder.className = "folder";

          const header = document.createElement("div");
          header.className = "folder-header";
          header.textContent = category;

          header.onclick = () => openCategoryModal(category, docs);

          const content = document.createElement("div");
          content.className = "folder-content"; // not used (we use modal)

          folder.appendChild(header);
          folder.appendChild(content);
          list.appendChild(folder);
        });
      } catch (err) {
        console.error("Error fetching documents", err);
      }
    }

    function openCategoryModal(category, docs) {
      document.getElementById("modalTitle").textContent = category;
      const modalBody = document.getElementById("modalBody");
      modalBody.innerHTML = "";

      const categoryDocs = docs.filter(doc => doc.docType === category);
      if (categoryDocs.length > 0) {
        categoryDocs.forEach(doc => {
          const url = resolveDocUrl(doc);
          const fullName = (doc.scholar && doc.scholar.fullname) ? doc.scholar.fullname : (doc.fullname || "Unknown");
          const batch = (doc.scholar && doc.scholar.batchYear) ? doc.scholar.batchYear : (doc.batchYear || "N/A");
          const date = doc.dateSubmitted ? new Date(doc.dateSubmitted).toLocaleString() : "";
          const status = (doc.status || "Pending");
          const statusCls = status.toLowerCase();

          // Only show delete button if status is Pending
          const showDelete = status.toLowerCase() === "pending";

          // show reason if rejected + reason exists
          const reasonText = getRejectReason(doc);
          const reasonMarkup = (status.toLowerCase() === "rejected" && reasonText)
            ? `<div class="rejectNote"><strong>Reason:</strong> ${reasonText}</div>`
            : ``;

          const item = document.createElement("div");
          item.className = "docItem";
          item.innerHTML = `
            <p class="docText">
              ${url ? `<a href="${url}" target="_blank" rel="noopener">${fullName} (${batch})</a>`
              : `${fullName} (${batch})`}
              <br><small>Submitted: ${date}</small>
              <br><span class="status ${statusCls}">Status: ${status}</span>
            </p>
            ${reasonMarkup}
            ${showDelete
              ? `<button class="deleteBtn" data-docid="${doc._id}" title="Delete this file (Pending only)">
                   <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                     <polyline points="3 6 5 6 21 6"></polyline>
                     <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                     <path d="M10 11v6"></path>
                     <path d="M14 11v6"></path>
                     <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
                   </svg>
                 </button>`
              : ``}
          `;
          modalBody.appendChild(item);
        });
      } else {
        modalBody.innerHTML = "<p style='color:#555; font-size:13px;'>No documents in this folder.</p>";
      }

      document.getElementById("docModal").style.display = "block";
    }

    // Delegate delete clicks inside modal body
    document.getElementById("modalBody").addEventListener("click", async (e) => {
      const btn = e.target.closest(".deleteBtn");
      if (!btn) return;

      const docId = btn.getAttribute("data-docid");
      if (!docId) return;

      const ok = confirm("Delete this pending document? This cannot be undone.");
      if (!ok) return;

      try {
        const res = await fetch(`/api/documents/${docId}`, {
          method: "DELETE",
          credentials: "include"
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          alert(data.msg || "Delete failed. Only Pending documents can be deleted.");
          return;
        }

        alert("Deleted.");
        document.getElementById("docModal").style.display = "none";
        fetchDocuments();
      } catch (err) {
        console.error("Delete error:", err);
        alert("Delete error. Please try again.");
      }
    });

    // ---- Modal close
    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("docModal");
      const closeBtn = document.querySelector(".close");

      closeBtn.onclick = () => { modal.style.display = "none"; };
      window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };
    });

    // Initial fetch
    window.onload = fetchDocuments;
  </script>
</body>

</html>
