<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Page</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      outline: none;
      border: none;
      text-decoration: none;
      box-sizing: border-box;
      font-family: Arial, Helvetica, sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-image: url('iskolarbg.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .mainContainer {
      width: 1000px;
      height: 550px;
      border-radius: 20px;
      overflow: hidden;
      display: flex;
      justify-content: space-around;
      align-items: center;
      background-image: linear-gradient(to right, rgba(146, 59, 59, 0.6), rgba(255, 255, 255, 0.6));
      box-shadow: 0 20px 35px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }

    .assignedTasks {
      width: 300px;
      height: 450px;
      background-color: #fff;
      box-shadow: 0 20px 35px rgba(0, 0, 0, 0.1);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 10px;
    }

    .createTask {
      width: 500px;
      height: 450px;
      background-color: #fff;
      box-shadow: 0 20px 35px rgba(0, 0, 0, 0.1);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 10px;
    }

    .assignedTasks h2 {
      margin-bottom: 10px;
      justify-content: first baseline;
    }

    .inputBox {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .inputBox label {
      font-weight: bold;
      margin-top: 5px;
    }

    .inputBox input {
      background-color: rgb(201, 201, 201);
      border-radius: 20px;
      padding: 8px 12px;
    }

    .taskDescription textarea {
      background-color: rgb(201, 201, 201);
      margin-top: 5px;
      border-radius: 20px;
      padding: 8px 12px;
      resize: none;
      width: 100%;
      height: 100px;
    }

    .createButton {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }

    .createButton button {
      height: 35px;
      padding: 0 16px;
      border-radius: 10px;
      background-color: rgba(146, 59, 59);
      color: #fff;
      cursor: pointer;
      font-weight: bold;
    }

    .dateRow {
      display: flex;
      gap: 20px;
    }

    .dateRow .inputGroup {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .dateRow .inputGroup input {
      background-color: rgb(201, 201, 201);
      border-radius: 20px;
      padding: 8px 12px;
      font-weight: bold;
      border: none;
      height: 38px;
      /* same height across all inputs */
      width: 100%;
      /* full width in its flex container */
      box-sizing: border-box;
    }
  </style>
</head>

<body>
  <main>
    <div class="mainContainer">
      <!-- Display Event (left) -->
      <div class="assignedTasks">
        <h2>Assigned Tasks</h2>
      </div>

      <!-- Create Event (right) -->
      <div class="createTask">
        <h2>Create Task</h2>
        <form id="taskForm" class="inputBox">
          <label>Task Title</label>
          <input type="text" name="taskTitle" required>

          <div class="dateRow"> <!--NEED TO CHANGE INTO DATE BUTTON-->
            <div class="inputGroup">
              <label>Start Date</label>
              <input type="text" id="pikadayStartDate" name="startDate" placeholder="Select a date" required>
            </div>
            <div class="inputGroup">
              <label>Due Date</label>
              <input type="text" id="pikadayDueDate" name="dueDate" placeholder="Select a date" required>
            </div>
          </div>

          <div class="taskDescription">
            <label>Task Description</label>
            <textarea name="taskDesc" required></textarea>
          </div>

          <div class="createButton">
            <button type="reset">Reset</button>
            <button type="submit">Create Task</button>
          </div>
        </form> <!---->
      </div>
    </div>
  </main>

<script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>
<script>
  new Pikaday({
    field: document.getElementById('pikadayStartDate'),
    format: 'YYYY-MM-DD', 
    minDate: new Date(),
    toString(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
});

new Pikaday({
    field: document.getElementById('pikadayDueDate'),
    format: 'YYYY-MM-DD', 
    minDate: new Date(),
    toString(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
});

 // Fetch and display tasks
 async function loadTasks() {
    try {
      const res = await fetch('/tasks');
      const tasks = await res.json();

      //Sort tasks by startDate
      tasks.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

      const assignedTasksDiv = document.querySelector('.assignedTasks');
      assignedTasksDiv.innerHTML = '<h2>Assigned Tasks</h2>'; // reset with heading

      if (tasks.length === 0) {
        assignedTasksDiv.innerHTML += '<p>No tasks assigned yet.</p>';
        return;
      }

      tasks.forEach(task => {
        const taskEl = document.createElement('div');
        taskEl.style.padding = '10px';
        taskEl.style.border = '1px solid #ccc';
        taskEl.style.borderRadius = '10px';
        taskEl.style.background = '#f9f9f9';
        taskEl.innerHTML = `
          <strong>${task.title}</strong><br>
          <small>${task.startDate} → ${task.dueDate}</small><br>
          <em>${task.description}</em>
        `;
        assignedTasksDiv.appendChild(taskEl);
      });
    } catch (err) {
      console.error('Failed to load tasks', err);
    }
  }

// Handle task form submission

document.getElementById('taskForm').addEventListener('submit', async function(e) {
  e.preventDefault(); // stop default form submission

  const formData = {
    title: this.taskTitle.value,
    description: this.taskDesc.value,
    startDate: this.startDate.value,  // mapping to your schema field
    dueDate: this.dueDate.value    // you can rename this in schema if needed
  };

  try {
    const res = await fetch('/tasks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });

    const data = await res.json();
    if (res.ok) {
      alert('✅ Task created successfully!');
      this.reset();
      loadTasks();
    } else {
      alert('❌ Error: ' + data.message);
    }
  } catch (err) {
    alert('❌ Failed to send request: ' + err.message);
  }
});

window.onload = loadTasks;
</script>
</body>
</html>