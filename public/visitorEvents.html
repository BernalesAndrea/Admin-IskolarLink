<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>IskolarLink — Events (Public)</title>

  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">

  <link rel="stylesheet" href="/assets/css/style.css">

  <style>
    :root{
      --gold:#D4A017;
      --maroon:#800000;
      --maroon-dark:#5a0000;
      --maxw:1200px;
      --muted:#666;
      --card: rgba(255,255,255,0.98);
      --glass: rgba(255,255,255,0.92);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      background-image:url('/assets/iskolarbg.png');
      background-size:cover;
      background-position:center;
      font-family:"Segoe UI", Roboto, Arial, Helvetica, sans-serif;
      color:#222;
    }

    /* header / layout (copied style from visitorHome.html) */
    .site-header { background: var(--maroon); border-bottom:2px solid var(--maroon-dark); }
    .header-wrap{ max-width:var(--maxw); margin:0 auto; padding:10px 16px; display:flex; align-items:center; gap:12px; }
    .header-logo{ width:56px; height:56px; background-repeat:no-repeat; background-position:center; background-size:contain; display:block; }
    .logo-city{ background-image:url('/assets/citylogo.png'); }
    .logo-isko{ background-image:url('/assets/iskologo.png'); }
    .brand-block{ color:#fff; display:flex; flex-direction:column; gap:2px; }
    .brand-title{ font-weight:800; font-size:18px; letter-spacing:0.02em; }
    .brand-sub{ font-size:12px; opacity:0.95; }

    .header-right { margin-left:auto; display:flex; align-items:center; gap:12px; }
    .header-contact { color:#fff; text-decoration:none; font-weight:600; font-size:13px; opacity:0.95; }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.18); color:#fff; padding:8px 12px; border-radius:8px; text-decoration:none; font-weight:700; }
    .btn-solid { background:var(--gold); color:#000; padding:8px 12px; border-radius:8px; text-decoration:none; font-weight:800; border:1px solid rgba(0,0,0,0.08); }

    /* main stretches so footer pins to bottom */
    main.page-wrap{ max-width:var(--maxw); margin:26px auto; padding:18px; width:calc(100% - 36px); flex:1; }

    /* grid: calendar (left) + upcoming list (right) */
    .events-grid{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:18px;
      align-items:start;
    }

    .card{ background:var(--card); padding:16px; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04); }

    /* calendar container */
    #calendar {
      background:#fff;
      border-radius:10px;
      padding:10px;
      box-shadow:0 6px 18px rgba(0,0,0,0.04);
    }

    /* upcoming list */
    .upcoming {
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .upcoming h3 { margin:0 0 6px 0; color:var(--maroon); }
    .event-mini {
      background:#fff;
      border-radius:10px;
      padding:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.04);
      display:flex;
      gap:12px;
      align-items:center;
    }
    .event-date {
      min-width:64px; text-align:center; padding:8px; border-radius:8px; background:var(--maroon); color:#fff; font-weight:800;
    }
    .event-info h4{ margin:0; font-size:1rem; color:#000; }
    .event-info p{ margin:6px 0 0; color:var(--muted); font-size:13px; }

    /* search/filter bar above calendar */
    .controls { display:flex; gap:10px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
    .controls .search { flex:1; min-width:200px; padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:var(--glass); }
    .controls .select { padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:var(--glass); }

    /* modal (read-only event details) */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.45);
      z-index:2200;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .modal-inner{
      background:#fff;
      width:100%;
      max-width:760px;
      border-radius:12px;
      max-height:86vh;
      overflow:auto;
      padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,0.35);
    }
    .modal-close{ float:right; background:none;border:none;font-size:20px;font-weight:800;color:#333; cursor:pointer; }

    .muted{ color:var(--muted); }

    /* ========= FOOTER (GLOBAL FOOTER) ========= */
    .site-footer{
      background:#fff;
      border-top:1px solid #000;
      outline:1px solid #000;
      outline-offset:-1px;
      /* ensure footer hugs bottom when page short */
      margin-top: auto;
    }
    .footer-wrap{
      max-width:1200px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .footer-wrap img{
      max-height:48px;
      width:auto;
      display:block;
    }

    
    input[type="checkbox"]:checked ~ .slide { transform: translateX(0); }
    .slide .image { text-align:center; padding:18px 0 8px; }
    .slide .image img { max-width:120px; height:auto; display:block; margin:0 auto; }
    .slide ul { list-style:none; padding:6px 8px; margin:0; overflow:auto; flex:1; }
    .slide ul li { margin:6px 0; }
    .slide ul li a { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:8px; color:#222; text-decoration:none; font-weight:600; }
    .slide ul li a:hover { background:var(--maroon); color:#fff; }
    .profile-box { padding:12px; border-top:1px solid #eee; display:flex; align-items:center; gap:10px; }
    .profile-box img { width:48px; height:48px; border-radius:50%; object-fit:cover; }
    .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:1400; transition:opacity .28s ease; opacity:0; pointer-events:none; }
    input[type="checkbox"]:checked ~ .overlay { display:block; opacity:1; pointer-events:auto; }

    @media (max-width:920px){
      .events-grid{ grid-template-columns: 1fr; }
      .controls{ gap:8px; }
      .toggle{ left:10px; top:10px; }
      .slide{ width:100%; transform:translateX(-100%); }
      input[type="checkbox"]:checked ~ .slide { transform: translateX(0); }
    }
  </style>
</head>
<body>
  

  <!-- HEADER -->
  <header class="site-header" role="banner" style="position:relative; z-index:1200">
    <div class="header-wrap">
      <a class="header-logo logo-city" href="https://koronadal.gov.ph" target="_blank" aria-label="City of Koronadal"></a>
      <div class="brand-block" aria-hidden="true">
        <div class="brand-title">CITY OF KORONADAL</div>
        <div class="brand-sub">Iskolar ng Koronadal - Kabugwason Paglaum Program</div>
      </div>
      <a class="header-logo logo-isko" href="https://www.facebook.com/profile.php?id=100093335296692" target="_blank" aria-label="Isko Facebook"></a>

      <div class="header-right" role="navigation" aria-label="Header actions">
        <a class="header-contact" href="tel:+63832286095">(083) 228 - 6095</a>
        <a class="header-contact" href="mailto:info.koronadalcity@gmail.com">info.koronadalcity@gmail.com</a>
        <a href="/login.html" class="btn-ghost" title="Login">Login</a>
        <a href="/signup.html" class="btn-solid" title="Sign up">Sign up</a>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="page-wrap" role="main">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <h1 style="margin:0;color:var(--maroon)">Event Calendar</h1>
        <div style="display:flex; gap:8px; align-items:center; flex:1; max-width:640px;">
          <input id="search" class="search" type="search" placeholder="Search events by title, location, or description...">
          <select id="whenFilter" class="select" aria-label="Filter events">
            <option value="all">All</option>
            <option value="upcoming">Upcoming</option>
            <option value="past">Past</option>
          </select>
          <button id="refresh" class="btn-ghost" title="Refresh">⟳</button>
        </div>
      </div>

      <div class="events-grid" style="margin-top:14px;">
        <div>
          <div id="calendar"></div>
        </div>

        <aside>
          <div class="card" style="padding:12px">
            <h3 style="margin-top:0">Upcoming Events</h3>
            <div id="upcomingList" class="upcoming" aria-live="polite">
              <div class="muted">Loading events…</div>
            </div>

            <div style="margin-top:12px; text-align:center;">
              <a href="/public/visitorEvents.html" class="btn-ghost" style="text-decoration:none">View all in calendar</a>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <!-- Event detail modal (read-only for visitors) -->
  <div id="eventModal" class="modal" aria-hidden="true">
    <div class="modal-inner" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <button class="modal-close" id="modalClose" aria-label="Close">&times;</button>
      <h2 id="modalTitle" style="color:var(--maroon);margin-top:0"></h2>
      <div id="modalMeta" style="color:var(--muted);font-weight:700;margin-bottom:12px"></div>
      <div id="modalBody" style="white-space:pre-line;line-height:1.6;color:#333"></div>
      <div style="margin-top:12px;color:var(--muted);font-size:13px">
        <strong>Note:</strong> This is the public view. If you are a registered scholar, log in to RSVP or see additional details.
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="footer-wrap">
      <img src="/assets/footer.png" alt="Footer Graphic">
    </div>
  </footer>

  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <script>
    // Utilities
    function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    function niceDate(dt){
      try {
        return new Date(dt).toLocaleString(undefined, {
          weekday:'short', year:'numeric', month:'short', day:'numeric',
          hour:'numeric', minute:'2-digit'
        });
      } catch(e) { return String(dt); }
    }

    // State
    let eventsCache = [];

    const calendarEl = document.getElementById('calendar');
    const upcomingListEl = document.getElementById('upcomingList');
    const searchInput = document.getElementById('search');
    const whenFilter = document.getElementById('whenFilter');
    const refreshBtn = document.getElementById('refresh');

    // Fetch events (public) - returns array or []
    async function fetchEvents(){
      try {
        const res = await fetch('/api/events', { cache: 'no-store' });
        const data = await res.json();
        if(!Array.isArray(data)) return [];
        // normalize and sort asc by date
        data.sort((a,b)=> new Date(a.dateTime) - new Date(b.dateTime));
        return data;
      } catch (err) {
        console.error('fetchEvents error', err);
        return [];
      }
    }

    // Render upcoming events list (next 6 upcoming)
    function renderUpcoming(events){
      const now = Date.now();
      const upcoming = events.filter(ev => new Date(ev.dateTime) >= now).slice(0,6);
      upcomingListEl.innerHTML = '';
      if(upcoming.length === 0){
        upcomingListEl.innerHTML = '<div class="muted">No upcoming events.</div>';
        return;
      }
      upcoming.forEach(ev => {
        const dateObj = new Date(ev.dateTime);
        const month = dateObj.toLocaleString(undefined, { month:'short' });
        const day = dateObj.getDate();
        const el = document.createElement('div');
        el.className = 'event-mini';
        el.innerHTML = `
          <div class="event-date"><div style="font-size:12px">${month}</div><div style="font-size:18px;font-weight:800">${day}</div></div>
          <div class="event-info">
            <h4>${escapeHtml(ev.title || 'Untitled')}</h4>
            <p>${escapeHtml(ev.location || 'TBA')} • ${new Date(ev.dateTime).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })}</p>
          </div>
          <div style="margin-left:auto"><button class="viewBtn" data-id="${escapeHtml(ev._id||'')}" style="background:none;border:none;color:var(--maroon);font-weight:800;cursor:pointer">View</button></div>
        `;
        el.querySelector('.viewBtn').addEventListener('click', ()=> openModal(ev));
        upcomingListEl.appendChild(el);
      });
    }

    // Init FullCalendar and load events
    let fc = null;
    function initCalendar(events){
      // format events for FullCalendar
      const fcEvents = (events || []).map(ev => ({
        id: ev._id,
        title: ev.title,
        start: ev.dateTime,
        extendedProps: {
          location: ev.location,
          description: ev.description,
          duration: ev.duration,
          author: ev.author,
          category: ev.category
        }
      }));

      // destroy existing calendar if any
      if(fc) {
        try { fc.destroy(); } catch(e) {}
      }

      fc = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 640,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: fcEvents,
        eventClick: function(info){
          const id = info.event.id;
          const ev = (events || []).find(x => String(x._id) === String(id));
          if(ev) openModal(ev);
        },
        eventDisplay: 'block',
        dayMaxEvents: true
      });

      fc.render();
    }

    // Open details modal (read-only)
    function openModal(ev){
      const modal = document.getElementById('eventModal');
      document.getElementById('modalTitle').textContent = ev.title || 'Event';
      document.getElementById('modalMeta').textContent = `${niceDate(ev.dateTime)} • ${ev.location || 'TBA'} • ${ev.duration || 'N/A'}`;
      // show author & category if present
      let content = '';
      if(ev.description) content += ev.description + '\n\n';
      if(ev.category) content += `Category: ${ev.category}\n`;
      if(ev.author) content += `Posted by: ${ev.author}\n`;
      document.getElementById('modalBody').textContent = content.trim();
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
    }

    function closeModal(){
      const modal = document.getElementById('eventModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }

    document.getElementById('modalClose').addEventListener('click', closeModal);
    window.addEventListener('click', e => { const modal = document.getElementById('eventModal'); if(e.target === modal) closeModal(); });

    // Filtering logic (search + when)
    function applyFiltersToView(){
      const q = (searchInput.value || '').trim().toLowerCase();
      const when = whenFilter.value || 'all';
      let items = eventsCache.slice();

      if(when === 'upcoming'){
        items = items.filter(ev => new Date(ev.dateTime) >= Date.now());
      } else if(when === 'past'){
        items = items.filter(ev => new Date(ev.dateTime) < Date.now());
      }

      if(q){
        items = items.filter(ev => {
          const hay = ((ev.title||'') + ' ' + (ev.location||'') + ' ' + (ev.description||'') + ' ' + (ev.category||'')).toLowerCase();
          return hay.includes(q);
        });
      }

      // re-init calendar with filtered list
      initCalendar(items);
      // render upcoming list (from filtered items)
      renderUpcoming(items);
    }

    // load and render flow
    async function loadAndRender(){
      // fetch
      eventsCache = await fetchEvents();
      // init calendar and upcoming
      initCalendar(eventsCache);
      renderUpcoming(eventsCache);
    }

    // wire controls
    document.addEventListener('DOMContentLoaded', async function(){
      await loadAndRender();

      searchInput.addEventListener('input', ()=> {
        applyFiltersToView();
      });

      whenFilter.addEventListener('change', ()=> {
        applyFiltersToView();
      });

      refreshBtn.addEventListener('click', async ()=>{
        refreshBtn.textContent = '⟳';
        eventsCache = await fetchEvents();
        applyFiltersToView();
        refreshBtn.textContent = '⟳';
      });
    });
  </script>
</body>
</html>
