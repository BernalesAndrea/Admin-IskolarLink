<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>IskolarLink — Announcements (Public)</title>

  <link rel="stylesheet" href="/assets/css/style.css">

  <style>
    /* (styles preserved exactly, but nav-related CSS no longer used) */
    :root{
      --gold:#D4A017;
      --maroon:#800000;
      --maroon-dark:#5a0000;
      --maxw:1200px;
      --muted:#666;
      --card: rgba(255,255,255,0.98);
      --glass: rgba(255,255,255,0.92);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      background-image:url('/assets/iskolarbg.png');
      background-size:cover;
      background-position:center;
      font-family:"Segoe UI", Roboto, Arial, Helvetica, sans-serif;
      color:#222;
    }

    /* Removed NAV, but header layout is still referenced — safe to keep */
    /* You may remove header styles if no longer needed */

    main.page-wrap{ max-width:var(--maxw); margin:26px auto; padding:18px; width:calc(100% - 36px); flex:1; }

    .top-controls{ display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .search-input{ flex:1; min-width:220px; padding:10px 12px; border-radius:8px; border:1px solid #ddd; background:var(--glass); }
    .select { padding:10px 12px; border-radius:8px; border:1px solid #ddd; background:var(--glass); }
    .btn { padding:10px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
    .btn-secondary { background:#fff; border:1px solid rgba(0,0,0,0.08); }

    .container-card{ background:var(--card); padding:14px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.06); }

    .announcements-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(320px,1fr));
      gap:14px;
      margin-top:12px;
    }

    .announcement-card{
      background:#fff;
      border-radius:12px;
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
      transition:transform .15s ease, box-shadow .15s ease;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:180px;
    }
    .announcement-card:hover{ transform:translateY(-6px); box-shadow:0 10px 26px rgba(0,0,0,0.08); }

    .ann-title{ font-weight:800; color:var(--maroon); font-size:1.05rem; }
    .ann-meta{ font-size:12px; color:var(--muted); font-weight:700; }
    .ann-body{ color:#333; line-height:1.45; flex:1; overflow:hidden; }

    .card-actions{ display:flex; gap:8px; align-items:center; margin-top:8px; }

    .muted{ color:var(--muted); }

    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.45);
      z-index:2200;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .modal-inner{
      background:#fff;
      width:100%;
      max-width:880px;
      border-radius:12px;
      max-height:86vh;
      overflow:auto;
      padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,0.35);
    }
    .modal-close{ float:right; background:none;border:none;font-size:20px;font-weight:800;color:#333; cursor:pointer; }

    .site-footer{
      background:#fff;
      border-top:1px solid #000;
      outline:1px solid #000;
      outline-offset:-1px;
      margin-top: auto;
    }
    .footer-wrap{
      max-width:1200px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .footer-wrap img{
      max-height:48px;
      width:auto;
      display:block;
    }
  </style>
</head>

<body>
  <!-- ❌ NAV REMOVED (nav-root + slide nav + toggle) -->
  <!-- ❌ HEADER REMOVED -->

  <main class="page-wrap" role="main">
    <div class="container-card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <h1 style="margin:0;color:var(--maroon)">Announcements</h1>

        <div class="top-controls" style="flex:1;max-width:760px;margin-left:12px">
          <input id="q" class="search-input" type="search" placeholder="Search announcements..." aria-label="Search announcements">
          <select id="categoryFilter" class="select" aria-label="Filter by category">
            <option value="">All categories</option>
          </select>
          <button id="refreshBtn" class="btn btn-secondary" title="Refresh announcements">⟳ Refresh</button>
        </div>
      </div>

      <p style="margin:10px 0 0;color:var(--muted)">This public page shows all announcements published by the scholarship program.</p>

      <div id="announcementsGrid" class="announcements-grid" aria-live="polite" style="margin-top:14px">
        <div class="muted">Loading announcements…</div>
      </div>

      <div style="margin-top:12px; display:flex; justify-content:center;">
        <button id="loadMore" class="btn btn-secondary" style="display:none">Load more</button>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-wrap">
      <img src="/assets/footer.png" alt="Footer Graphic">
    </div>
  </footer>

  <!-- Modal (unchanged) -->
  <div id="annModal" class="modal" aria-hidden="true">
    <div class="modal-inner" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <button class="modal-close" id="modalClose" aria-label="Close">&times;</button>
      <h2 id="modalTitle" style="color:var(--maroon);margin-top:0"></h2>
      <div id="modalMeta" style="color:var(--muted);font-weight:700;margin-bottom:12px"></div>
      <div id="modalContent" style="white-space:pre-line;line-height:1.6;color:#333"></div>
    </div>
  </div>

  <!-- JS (unchanged) -->
    <script>
    // Utilities
    function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    function niceDate(d){ try{ return new Date(d).toLocaleString(undefined,{ weekday:'short', year:'numeric', month:'short', day:'numeric', hour:'numeric', minute:'2-digit' }); }catch(e){ return String(d); } }

    // State
    let allAnnouncements = [];
    let pageSize = 12;
    let currentPage = 1;
    let categories = new Set();

    const grid = document.getElementById('announcementsGrid');
    const qInput = document.getElementById('q');
    const catFilter = document.getElementById('categoryFilter');
    const refreshBtn = document.getElementById('refreshBtn');
    const loadMoreBtn = document.getElementById('loadMore');

    async function fetchAnnouncements(){
      grid.innerHTML = '<div class="muted">Loading announcements…</div>';
      try {
        const res = await fetch('/announcements', { cache: 'no-store' });
        const data = await res.json();
        if(!Array.isArray(data)) return [];
        // sort newest first
        data.sort((a,b)=> new Date(b.date) - new Date(a.date));
        return data;
      } catch (err) {
        console.error('fetch announcements error', err);
        grid.innerHTML = '<div class="muted">Unable to load announcements.</div>';
        return [];
      }
    }

    function renderCategories(){
      // populate category select
      const arr = Array.from(categories).sort();
      catFilter.innerHTML = '<option value="">All categories</option>';
      arr.forEach(c=>{
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        catFilter.appendChild(opt);
      });
    }

    function filterAndPaginate(){
      const q = (qInput.value || '').trim().toLowerCase();
      const cat = (catFilter.value || '').trim();
      let filtered = allAnnouncements.filter(a=>{
        // public requirement: show everything published to scholars too (per your request)
        // filter by category if selected
        if(cat && String(a.category || '').toLowerCase() !== cat.toLowerCase()) return false;
        if(!q) return true;
        const hay = ((a.title||'') + ' ' + (a.content||'') + ' ' + (a.category||'')).toLowerCase();
        return hay.includes(q);
      });

      const start = 0;
      const end = currentPage * pageSize;
      const page = filtered.slice(start, end);
      // show load more if more available
      if(filtered.length > page.length){
        loadMoreBtn.style.display = 'inline-block';
      } else {
        loadMoreBtn.style.display = 'none';
      }
      return page;
    }

    function renderList(items){
      grid.innerHTML = '';
      if(!items || items.length === 0){
        grid.innerHTML = '<div class="muted">No announcements match your search.</div>';
        return;
      }

      items.forEach(a=>{
        const el = document.createElement('article');
        el.className = 'announcement-card';
        const when = niceDate(a.date);
        // trim preview
        let preview = (a.content || '').replace(/\s+/g,' ').slice(0,240);
        if((a.content||'').length > 240) preview += '...';

        el.innerHTML = `
          <div class="ann-title">${escapeHtml(a.title || 'Untitled')}</div>
          <div class="ann-meta">${escapeHtml(when)} • ${escapeHtml(a.category || 'General')}</div>
          <div class="ann-body">${escapeHtml(preview)}</div>
          <div class="card-actions">
            <button class="btn btn-secondary readBtn" data-id="${escapeHtml(a._id || '')}">Read</button>
            <div style="margin-left:auto; font-size:12px; color:var(--muted); align-self:flex-end">Posted by ${escapeHtml(a.author || 'Admin')}</div>
          </div>
        `;
        // read button
        el.querySelector('.readBtn').addEventListener('click', ()=>{
          openModal(a);
        });
        grid.appendChild(el);
      });
    }

    function openModal(a){
      const m = document.getElementById('annModal');
      document.getElementById('modalTitle').textContent = a.title || 'Announcement';
      document.getElementById('modalMeta').textContent = `${niceDate(a.date)} • ${a.category || 'General'}`;
      // prefer HTML? we sanitize by escaping then preserving line breaks
      document.getElementById('modalContent').textContent = a.content || '';
      m.style.display = 'flex';
      m.setAttribute('aria-hidden', 'false');
    }

    function closeModal(){
      const m = document.getElementById('annModal');
      m.style.display = 'none';
      m.setAttribute('aria-hidden', 'true');
    }

    document.getElementById('modalClose').addEventListener('click', closeModal);
    window.addEventListener('click', e=>{
      const m = document.getElementById('annModal');
      if(e.target === m) closeModal();
    });

    // interactions
    qInput.addEventListener('input', ()=>{
      currentPage = 1; // reset pagination on search
      const items = filterAndPaginate();
      renderList(items);
    });

    catFilter.addEventListener('change', ()=>{
      currentPage = 1;
      const items = filterAndPaginate();
      renderList(items);
    });

    refreshBtn.addEventListener('click', async ()=>{
      await loadAndRender();
    });

    loadMoreBtn.addEventListener('click', ()=>{
      currentPage++;
      const items = filterAndPaginate();
      renderList(items);
      // smooth scroll to newly loaded area
      window.scrollTo({ top: document.body.scrollHeight - 600, behavior: 'smooth' });
    });

    // initialize: fetch announcements and populate grid + categories
    async function loadAndRender(){
      currentPage = 1;
      allAnnouncements = await fetchAnnouncements();
      // categories set
      categories = new Set((allAnnouncements || []).map(a => a.category || '').filter(Boolean));
      renderCategories();
      const items = filterAndPaginate();
      renderList(items);
    }

    // Auto-run on load
    (function init(){
      loadAndRender();
    })();
  </script>
</body>
</html>
