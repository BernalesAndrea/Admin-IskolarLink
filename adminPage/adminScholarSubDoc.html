<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Submitted Documents</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="/assets/js/notifications.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

  <style>
    :root {
      --maroon: #800000;
      --maroon-dark: #5a0000;
      --gold: #D4A017;
    }

    * {
      margin: 0;
      padding: 0;
      outline: none;
      border: none;
      text-decoration: none;
      box-sizing: border-box;
      font-family: Arial, Helvetica, sans-serif
    }

    /* ===== LAYOUT ===== */
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: url('/assets/iskolarbg.png') center/cover no-repeat;
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px
    }

        /* ===== HEADER ===== */
.site-header {
  background: var(--maroon);
  border-bottom: 2px solid var(--maroon-dark);
}

.header-wrap {
  max-width: 1200px;
  margin: 0 auto;
  padding: 10px 16px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.header-center {
  display: flex;
  align-items: center;
  gap: 18px;
  flex-wrap: nowrap;          /* prevent wrapping so both logos stay visible */
}

.header-logo{
  display: inline-block;         /* ensure width/height apply */
  width: 64px;
  height: 64px;
  background-repeat: no-repeat;
  background-position: center;
  background-size: contain;      /* fit the whole PNG */
  flex: 0 0 auto;
}

/* point to the files */
.logo-city { background-image: url('/assets/citylogo.png'); }
.logo-isko { background-image: url('/assets/iskologo.png'); }


.header-logo:focus-visible { box-shadow: 0 0 0 3px rgba(212,160,23,.55); }

/* Brand text is plain text (not links) */
.brand-block {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  color: #fff;
  min-width: 0;                /* allow text to shrink before logos */
}
.brand-title {
  color: #fff;
  font-weight: 800;
  font-size: 24px;
  transition: color 0.25s ease;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.brand-sub {
  margin-top: 4px;
  font-size: 14px;
  font-weight: 600;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Keep your original responsive sizes */
@media (max-width: 640px) {
  .header-logo {
    width: 48px;
    height: 48px;
    background-size: contain; /* scaled sprite for mobile */
  }
  .brand-title { font-size: 20px; }
  .brand-sub { font-size: 12px; }
}

/* === inline contact beside ISKO logo === */
.header-divider {
  width: 1px;
  height: 48px;
  background: rgba(255,255,255,.35);
  flex: 0 0 auto;
}

.header-contact-inline {
  display: flex;
  align-items: center;
  gap: 18px;
  color: #fff;
  flex: 0 0 auto;     /* don't steal space from logos */
  white-space: nowrap;
}

.contact-item { display: flex; align-items: center; gap: 8px; }
.contact-label { font-size: 12px; letter-spacing: .04em; text-transform: uppercase; opacity: .85; }
.contact-value a { color: #fff; font-weight: 700; text-decoration: none; }
.contact-value a:hover, .contact-value a:focus { text-decoration: underline; }

/* keep both logos visible on small screens */
@media (max-width: 740px) {
  .contact-label { display: none; }
  .contact-value a { font-weight: 600; font-size: 12px; }
}
@media (max-width: 520px) {
  .header-contact-inline { display: none; }  /* hide if super narrow */
}

    /* ===== MAIN CARD ===== */
    .container {
      width: 90%;
      height: 80vh;
      max-width: 1000px;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 2px solid #eee;
      background: #f9f9f9
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 14px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      transition: all .3s ease
    }

    .tab:hover {
      background: #eaeaea
    }

    .tab.active {
      background: var(--maroon);
      color: #fff;
      font-weight: bold
    }

    /* Content */
    .content {
      padding: 20px;
      min-height: 0;
      overflow-y: auto;
      flex: 1
    }

    .content-section {
      display: none
    }

    .content-section.active {
      display: block
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .05);
      table-layout: fixed
    }

    thead {
      background: var(--maroon);
      color: #fff
    }

    thead th {
      padding: 12px;
      font-size: 14px;
      text-align: left;
      letter-spacing: .5px
    }

    tbody td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
      color: #333;
      vertical-align: middle
    }

    tbody tr:hover {
      background: rgba(128, 0, 0, .08);
      transition: .3s
    }

    tbody tr:last-child td {
      border-bottom: none
    }

    .status-actions {
      display: flex;
      align-items: center;
      gap: 15px
    }

    .action-btn {
      cursor: pointer;
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 15px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background .3s ease, color .3s ease
    }

    .accept {
      background: #28a745;
      color: #fff
    }

    .accept:hover {
      background: #1e7e34
    }

    .reject {
      background: #dc3545;
      color: #fff
    }

    .reject:hover {
      background: #a71d2a
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      inset: 0;
      background: rgba(0, 0, 0, .5)
    }

    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 12px;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .2)
    }

    .modal-content h3 {
      margin-bottom: 15px;
      color: var(--maroon)
    }

    .close-btn {
      float: right;
      cursor: pointer;
      font-size: 20px;
      color: #333
    }

    .close-btn:hover {
      color: var(--maroon)
    }

    /* Larger preview & grades modal sizing */
    #docPreviewModal .modal-content {
      width: 80%;
      max-width: 900px;
      height: 80%
    }

    #gradesModal .modal-content {
      width: 500px;
      max-width: 95%
    }

    /* Upload form */
    .upload-form {
      margin-top: 15px
    }

    .upload-form label {
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
      color: #333
    }

    .upload-form select,
    .upload-form input[type="file"],
    .upload-form input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 2px solid var(--maroon);
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
      transition: border-color .2s ease, box-shadow .2s ease;
    }

    .upload-form select:focus,
    .upload-form input[type="file"]:focus,
    .upload-form input[type="text"]:focus {
      border-color: var(--maroon);
      box-shadow: 0 0 5px rgba(128, 0, 0, .3);
      outline: none;
    }

    .upload-form button {
      background: var(--maroon);
      color: #fff;
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background .3s ease
    }

    .upload-form button:hover {
      background: #a00000
    }

    #uploadStatus {
      margin-top: 15px;
      color: #333;
      font-weight: 500
    }

    .upload-form input[type="file"]::-webkit-file-upload-button {
      background: var(--maroon);
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background .3s ease;
      margin-right: 10px;
    }

    /* ===== FOOTER ===== */
    .site-footer {
      background: #fff;
      border-top: 1px solid #000;
      outline: 1px solid #000;
      outline-offset: -1px
    }

    .footer-wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 16px;
      display: flex;
      justify-content: center;
      align-items: center
    }

    .footer-wrap img {
      max-height: 48px;
      width: auto
    }

    @media (max-width: 640px) {
      .header-logo {
        width: 48px;
        height: 48px;
        background-size: contain;
      }
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="header-wrap">
      <div class="header-center">
        <!-- Left LOGO is the link (City site) -->
        <a class="header-logo logo-city" href="https://koronadal.gov.ph" target="_blank"
          aria-label="City of Koronadal"></a>

        <!-- Center text is plain text only -->
        <div class="brand-block">
          <div class="brand-title">CITY OF KORONADAL</div>
          <div class="brand-sub">Iskolar ng Koronadal - Kabugwason Paglaum Program</div>
        </div>

        <!-- Right LOGO is the link (ISKO-KPP Facebook) -->
        <a class="header-logo logo-isko" href="https://www.facebook.com/profile.php?id=100093335296692" target="_blank"
          aria-label="Iskolar ng Koronadal - Kabugwason Paglaum Program (Facebook)"></a>

        <!-- inline contact info (now on the same row) -->
        <div class="header-divider" aria-hidden="true"></div>
        <div class="header-contact-inline" role="group" aria-label="Contact Information">
          <div class="contact-item">
            <div class="contact-label">Call Us</div>
            <div class="contact-value"><a href="tel:+63832286095">(083) 228 - 6095</a></div>
          </div>
          <div class="contact-item">
            <div class="contact-label">Email Us</div>
            <div class="contact-value"><a href="mailto:info.koronadalcity@gmail.com">info.koronadalcity@gmail.com</a>
            </div>
          </div>
        </div>

      </div>
    </div>
  </header>
  <!-- MAIN -->
  <main>
    <div class="container">
      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-target="submitted">Submitted Documents</div>
        <div class="tab" data-target="grades">Submitted Grades</div>
        <div class="tab" data-target="folders">Scholar Folders</div>
        <div class="tab" data-target="uploads">Upload Documents</div>
      </div>

      <!-- Content -->
      <div class="content">
        <!-- Submitted Documents -->
        <div class="content-section active" id="submitted">
          <h2>Submitted Documents</h2>
          <table>
            <thead>
              <tr>
                <th>Scholar Name</th>
                <th>Document Type</th>
                <th>Date Submitted</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="docs-table-body"></tbody>
          </table>
        </div>

        <!-- Submitted Grades -->
        <div class="content-section" id="grades">
          <h2>Submitted Grades</h2>
          <table>
            <thead>
              <tr>
                <th>Scholar Name</th>
                <th>Batch Year</th>
                <th>School Year</th>
                <th>Semester</th>
                <th>Attachment</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="grades-table-body"></tbody>
          </table>
        </div>

        <!-- Upload Documents -->
        <div class="content-section" id="uploads">
          <h2>Upload Existing Documents</h2>
          <form id="uploadForm" class="upload-form" enctype="multipart/form-data">
            <!-- Scholar Search -->
            <label for="scholarSearch">Search Scholar:</label>
            <input type="text" id="scholarSearch" name="scholarName" list="scholarList" placeholder="Type to search..."
              required>
            <datalist id="scholarList"></datalist>
            <input type="hidden" id="scholarId" name="scholarId" required>

            <!-- Document Type -->
            <label for="docType">Document Type:</label>
            <select id="docType" name="docType" required>
              <option value="">-- Select Document Type --</option>
              <option value="Grades">Grades</option>
              <option value="Statement of Account">Statement of Account</option>
              <option value="Certificate of Registration">Certificate of Registration</option>
              <option value="Book Reimbursement">Book Reimbursement</option>
              <option value="Others">Others</option>
            </select>

            <!-- File Input -->
            <label for="docFile">Choose File (PDF, DOCX, JPG, PNG):</label>
            <input type="file" id="docFile" name="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>

            <!-- Upload Button -->
            <button type="submit"><i class="fa fa-upload"></i> Upload Document</button>
          </form>
          <div id="uploadStatus"></div>
        </div>

        <!-- Scholar Folders -->
        <div class="content-section" id="folders">
          <h2>Scholar Folders</h2>
          <table>
            <thead>
              <tr>
                <th>Scholar Name</th>
                <th>Folder</th>
                <th>Last Updated</th>
              </tr>
            </thead>
            <tbody id="folders-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="footer-wrap">
      <img src="/assets/footer.png" alt="Footer Graphic">
    </div>
  </footer>

  <!-- Document Preview Modal -->
  <div id="docPreviewModal" class="modal">
    <div class="modal-content" style="height:80%;">
      <span class="close-btn" id="closePreview">&times;</span>
      <h3>Document Preview</h3>
      <iframe id="docFrame" src="" style="width:100%; height:90%; border:none;"></iframe>
    </div>
  </div>

  <!-- Folder Modal -->
  <div id="folderModal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h3>Scholar Folder</h3>
      <ul>
        <li><a href="#">üìÑ Scanned Grades</a></li>
        <li><a href="#">üìÑ Statement of Account</a></li>
        <li><a href="#">üìÑ Certificate of Registration</a></li>
        <li><a href="#">üìÑ Book Reimbursement</a></li>
        <li><a href="#">üìÑ Others</a></li>
      </ul>
    </div>
  </div>

  <!-- Reject Reason Modal -->
  <div id="rejectReasonModal" class="modal">
    <div class="modal-content" style="width:420px; max-width:95%;">
      <span class="close-btn" id="closeReject">&times;</span>
      <h3>Reject Document</h3>
      <p style="margin:8px 0 6px;">Provide a reason for rejection:</p>
      <textarea id="rejectReasonInput"
        style="width:100%; min-height:110px; padding:10px; border:1px solid #ccc; border-radius:8px; resize:vertical;"
        placeholder="e.g., File is incomplete / incorrect document type / unreadable scan..."></textarea>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
        <button id="rejectCancelBtn"
          style="background:#6c757d; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer;">Cancel</button>
        <button id="rejectSubmitBtn"
          style="background:#dc3545; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer;">Reject</button>
      </div>
    </div>
  </div>

  <script>

    // cache the latest pulls so we can compute "Last Updated" per scholar
    const cache = { docs: [], grades: [] };

    /* ---------- URL helpers ---------- */
    function fileUrl(bucket, id, opts = { download: false }) {
      if (!bucket || !id) return null;
      return opts.download ? `/files/${bucket}/${id}/download` : `/files/${bucket}/${id}`;
    }
    function resolveDocUrl(row, legacyField = 'filePath') { return fileUrl(row.bucket, row.fileId) || row[legacyField] || null; }
    function resolveGradeAttachmentUrl(grade) { return fileUrl(grade.attachmentBucket, grade.attachmentId) || grade.attachment || null; }

    /* ---------- Fetch & render: documents ---------- */
    async function fetchDocuments() {
      try {
        const res = await fetch("/api/admin/documents", { credentials: "include" });
        if (!res.ok) throw new Error("Failed to fetch documents");
        const docs = await res.json();
        cache.docs = Array.isArray(docs) ? docs : [];
        const tbody = document.getElementById("docs-table-body");
        tbody.innerHTML = "";

        // üîΩ Hide accepted docs in the verification list
        const toShow = docs.filter(d => {
          const s = String(d.status ?? "Pending").trim().toLowerCase();
          return !["accepted", "rejected"].includes(s);
        });

        toShow.forEach(doc => {
          const submittedDate = doc.createdAt
            ? new Date(doc.createdAt).toLocaleDateString()
            : (doc.dateSubmitted ? new Date(doc.dateSubmitted).toLocaleDateString() : "");

          const url = doc.fileUrl || resolveDocUrl(doc);

          // üîÅ normalize for display
          const dtype = (String(doc.docType || '').trim().toLowerCase() === 'soa')
            ? 'Statement of Account'
            : (doc.docType || '');

          const row = document.createElement("tr");
          row.innerHTML = `
    <td>${doc.scholar ? doc.scholar.fullname : (doc.fullname || '')}</td>
    <td>${dtype}</td>
    <td>${submittedDate}</td>
    <td>
      <div class="status-actions">
        <span>${doc.status || 'Pending'}</span>
        ${url ? `<button class="action-btn" style="background:#007bff;color:#fff;" onclick="previewDoc('${url.replace(/'/g, "\\'")}')"><i class="fa-solid fa-eye"></i></button>` : ''}
        <button class="action-btn accept" onclick="updateStatus('${doc._id}','accepted')"><i class="fa-solid fa-check"></i></button>
        <button class="action-btn reject" onclick="updateStatus('${doc._id}','rejected')"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </td>`;
          tbody.appendChild(row);
        });

      } catch (err) { console.error("Error fetching documents:", err); }
    }


    /* ---------- Fetch & render: grades ---------- */
    async function fetchGrades() {
      try {
        const res = await fetch("/api/admin/grades", { credentials: "include" });
        if (!res.ok) throw new Error("Failed to fetch grades");
        const grades = await res.json();
        cache.grades = Array.isArray(grades) ? grades : [];

        const tbody = document.getElementById("grades-table-body");
        tbody.innerHTML = "";

        // hide accepted & rejected from verification list
        const toShow = grades.filter(g => {
          const s = String(g.status ?? "Pending").trim().toLowerCase();
          return !["accepted", "rejected"].includes(s);
        });

        // ‚úÖ helper to safely get a timestamp
        const safeTime = (g) => {
          const d = g.createdAt || g.dateSubmitted;
          const t = d ? Date.parse(d) : NaN;
          if (!Number.isNaN(t)) return t;
          // fallback: derive time from ObjectId if it's a 24-hex string
          const id = (g._id || "") + "";
          if (id.length === 24) {
            const seconds = parseInt(id.slice(0, 8), 16);
            if (Number.isFinite(seconds)) return seconds * 1000;
          }
          return 0;
        };

        // ‚úÖ newest first
        toShow.sort((a, b) => safeTime(b) - safeTime(a));

        toShow.forEach(grade => {
          const attachmentUrl = resolveGradeAttachmentUrl(grade);
          const row = document.createElement("tr");
          row.innerHTML = `
          <td>${grade.scholar ? grade.scholar.fullname : grade.fullname}</td>
          <td>${grade.scholar ? (grade.scholar.batchYear ?? "") : (grade.batchYear ?? "")}</td>
          <td>${grade.schoolYear ?? ""}</td>
          <td>${grade.semester ?? ""}</td>
          <td>
            ${attachmentUrl
              ? `<button class="action-btn" style="background:#007bff;color:#fff;"
                  onclick="previewDoc('${attachmentUrl.replace(/'/g, "\\'")}')">
                  <i class="fa fa-eye"></i> Preview
                 </button>`
              : 'No file'}
          </td>
          <td>
            <div class="status-actions">
              <span>${grade.status || 'Pending'}</span>
              <button class="action-btn accept" onclick="updateGradeStatus('${grade._id}','accepted')">
                <i class="fa-solid fa-check"></i>
              </button>
              <button class="action-btn reject" onclick="updateGradeStatus('${grade._id}','rejected')">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          </td>`;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error("Error fetching grades:", err);
      }
    }

    /* ---------- Fetch & render: scholar folders ---------- */
    async function fetchScholarFolders() {
      try {
        const res = await fetch("/api/verified-scholars", { credentials: "include" });
        if (!res.ok) throw new Error("Failed to fetch scholars");
        const scholars = await res.json();

        // Build a map: scholarId -> latest millis of any doc/grade
        const latestByScholar = Object.create(null);
        const bump = (sid, dt) => {
          if (!sid || !dt) return;
          const t = new Date(dt).getTime();
          if (!Number.isFinite(t)) return;
          if (!latestByScholar[sid] || t > latestByScholar[sid]) latestByScholar[sid] = t;
        };

        // From documents
        (cache.docs || []).forEach(d => {
          const sid = d.scholar?._id || d.scholar; // populated or raw id
          bump(String(sid || ""), d.createdAt || d.uploadDate || d.date || d._id); // prefer createdAt
        });

        // From grades
        (cache.grades || []).forEach(g => {
          const sid = g.scholar?._id || g.scholar;
          bump(String(sid || ""), g.dateSubmitted || g.createdAt);
        });

        const tbody = document.getElementById("folders-tbody");
        tbody.innerHTML = "";
        scholars.forEach(s => {
          const sid = String(s._id);
          const ts = latestByScholar[sid];
          const lastUpdated = ts ? new Date(ts).toLocaleString() : "No uploads yet";
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>${s.fullname}</td>
        <td><a href="scholar-folder.html?scholarId=${s._id}" class="view-folder">View Folder</a></td>
        <td>${lastUpdated}</td>
      `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error fetching scholar folders:", err);
      }
    }


    /* ---------- Status updates ---------- */
    async function updateStatus(id, status) {
      try {
        await fetch(`/api/admin/documents/${id}/status`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ status })
        });
        fetchDocuments();
      } catch (err) { console.error("Error updating status:", err); }
    }
    async function updateGradeStatus(id, status) {
      try {
        await fetch(`/api/admin/grades/${id}/status`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ status })
        });
        fetchGrades();
      } catch (err) { console.error("Error updating grade status:", err); }
    }


    /* ---------- Preview modal ---------- */
    const previewModal = document.getElementById("docPreviewModal");
    const docFrame = document.getElementById("docFrame");
    const closePreview = document.getElementById("closePreview");
    let docImg = null;

    async function previewDoc(url) {
      try {
        const metaRes = await fetch((url + "/meta").replace("//meta", "/meta"), { credentials: "include" });
        let contentType = "";
        if (metaRes.ok) { const meta = await metaRes.json(); contentType = meta?.contentType || ""; }

        if (docImg) { docImg.remove(); docImg = null; }
        const isImage = contentType.startsWith("image/");
        if (isImage) {
          docFrame.style.display = "none";
          docImg = document.createElement("img");
          docImg.style.cssText = "width:100%;height:90%;object-fit:contain;border:none;";
          docImg.src = url;
          docFrame.parentElement.appendChild(docImg);
        } else {
          docFrame.src = url;
          docFrame.style.display = "block";
        }
        previewModal.style.display = "block";
      } catch (e) {
        console.error("Preview failed:", e);
        docFrame.src = url;
        docFrame.style.display = "block";
        previewModal.style.display = "block";
      }
    }
    window.previewDoc = previewDoc;

    closePreview.onclick = () => {
      previewModal.style.display = "none";
      docFrame.src = "";
      if (docImg) { docImg.remove(); docImg = null; }
    };

    /* ---------- Tabs ---------- */
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".content-section").forEach(c => c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.target).classList.add("active");
      });
    });

    /* ---------- Reject reason wrapper ---------- */
    (function () {
      const originalUpdateStatus = window.updateStatus;
      let pendingRejectDocId = null;

      window.updateStatus = function (id, status) {
        if (String(status).toLowerCase() === 'rejected') {
          pendingRejectDocId = id;
          document.getElementById('rejectReasonInput').value = '';
          document.getElementById('rejectReasonModal').style.display = 'block';
          return;
        }
        if (typeof originalUpdateStatus === 'function') { return originalUpdateStatus(id, status); }
      };

      const rejectModal = document.getElementById('rejectReasonModal');
      const rejectClose = document.getElementById('closeReject');
      const rejectCancelBtn = document.getElementById('rejectCancelBtn');
      const rejectSubmitBtn = document.getElementById('rejectSubmitBtn');
      const rejectInput = document.getElementById('rejectReasonInput');

      function closeReject() {
        rejectModal.style.display = 'none';
        pendingRejectDocId = null;
        rejectSubmitBtn.disabled = false;
      }
      rejectClose.onclick = closeReject;
      rejectCancelBtn.onclick = closeReject;
      window.addEventListener('click', e => { if (e.target === rejectModal) closeReject(); });

      rejectSubmitBtn.addEventListener('click', async () => {
        if (!pendingRejectDocId) return;
        const reason = (rejectInput.value || '').trim();
        if (!reason) { alert('Please provide a reason for rejection.'); return; }
        try {
          rejectSubmitBtn.disabled = true;
          const res = await fetch(`/api/admin/documents/${pendingRejectDocId}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ status: 'rejected', reason })
          });
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.msg || 'Failed to reject document');
          }
          closeReject();
          if (typeof fetchDocuments === 'function') fetchDocuments();
        } catch (err) {
          alert(err.message || 'Error submitting rejection');
          rejectSubmitBtn.disabled = false;
        }
      });
    })();

    /* ---------- Upload: scholar lookup + submit ---------- */
    let scholarMap = {};
    async function fetchScholarsForUpload() {
      try {
        const res = await fetch("/api/verified-scholars", { credentials: "include" });
        if (!res.ok) throw new Error("Failed to load scholars");
        const scholars = await res.json();
        const dl = document.getElementById("scholarList");
        dl.innerHTML = "";
        scholarMap = {};
        scholars.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.fullname;
          dl.appendChild(opt);
          scholarMap[s.fullname] = s._id;
        });
      } catch (err) { console.error(err); }
    }
    document.getElementById("scholarSearch").addEventListener("change", function () {
      const name = this.value;
      document.getElementById("scholarId").value = scholarMap[name] || "";
    });
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      const scholarName = formData.get("scholarName");
      const scholarId = formData.get("scholarId");

      // ensure name ‚Üí id mapping is valid
      if (!scholarName || !scholarMap[scholarName] || scholarMap[scholarName] !== scholarId) {
        alert("Please pick a scholar from the list.");
        return;
      }

      const statusDiv = document.getElementById("uploadStatus");
      statusDiv.textContent = "Uploading...";

      try {
        const res = await fetch("/api/admin/upload", {
          method: "POST",
          body: formData,
          credentials: "include"
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.msg || "Upload failed");
        }
        statusDiv.style.color = "green";
        statusDiv.textContent = "‚úÖ Document uploaded successfully!";
        form.reset();
        fetchDocuments();
      } catch (err) {
        statusDiv.style.color = "red";
        statusDiv.textContent = "‚ùå " + err.message;
      }
    });
    document.querySelector("[data-target='uploads']").addEventListener("click", fetchScholarsForUpload);

    /* ---------- Init + polling ---------- */
    fetchDocuments();
    fetchGrades();
    fetchScholarFolders();
    setInterval(fetchDocuments, 5000);
    setInterval(fetchGrades, 5000);
    setInterval(fetchScholarFolders, 5000);
  </script>
</body>

</html>