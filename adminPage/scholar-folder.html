<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scholar Folder</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="/assets/js/notifications.js" defer></script>
  <style>
    :root {
      --maroon: #800000;
      --maroon-dark: #5a0000;
      --gold: #D4A017;
    }

    * {
      margin: 0;
      padding: 0;
      outline: none;
      border: none;
      text-decoration: none;
      box-sizing: border-box;
      font-family: Arial, Helvetica, sans-serif;
    }

    /* ===== LAYOUT (match reference) ===== */
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: url('/assets/iskolarbg.png') center/cover no-repeat;
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    /* ===== HEADER (from reference) ===== */
    .site-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: var(--maroon);
      border-bottom: 2px solid var(--maroon-dark);
    }

    .header-wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 16px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .header-center {
      display: flex;
      align-items: center;
      gap: 18px;
    }

    .header-logo {
      height: 64px;
      width: auto;
      filter: drop-shadow(0 1px 0 rgba(0, 0, 0, .1));
    }

    .brand-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      color: #fff;
      user-select: none;
    }

    .brand-block>a {
      color: #fff;
      font-weight: 800;
      font-size: 24px;
      letter-spacing: .5px;
      transition: color .25s ease;
    }

    .brand-block>a:hover {
      color: var(--gold);
    }

    .brand-sub {
      margin-top: 4px;
      font-size: 14px;
      font-weight: 600;
    }

    .brand-sub a {
      color: #fff;
      transition: color .25s ease;
    }

    .brand-sub a:hover {
      color: var(--gold);
    }

    @media (max-width:640px) {
      .header-logo {
        height: 48px
      }

      .brand-block>a {
        font-size: 20px
      }

      .brand-sub {
        font-size: 12px
      }
    }

    /* ===== MAIN CARD (your page content) ===== */
    .container {
      width: 90%;
      height: 80vh;
      max-width: 1000px;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding: 18px;
    }

    /* keep your inner styles */
    h1,
    h2 {
      color: var(--maroon);
    }

    .meta {
      margin-bottom: 12px;
      color: #333
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin: 12px 0;
      border-bottom: 2px solid #eee;
      padding-bottom: 8px;
    }

    .tab {
      padding: 8px 12px;
      border-radius: 8px;
      background: #eee;
      cursor: pointer
    }

    .tab.active {
      background: var(--maroon);
      color: #fff
    }

    ul.docs {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    ul.docs li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    a.preview {
      text-decoration: none;
      color: #007bff
    }

    .small {
      font-size: 13px;
      color: #666
    }

    .btn {
      padding: 8px 10px;
      border-radius: 8px;
      background: var(--maroon);
      color: #fff;
      text-decoration: none
    }

    /* ===== FOOTER (from reference) ===== */
    .site-footer {
      background: #fff;
      border-top: 1px solid #000;
      outline: 1px solid #000;
      outline-offset: -1px;
    }

    .footer-wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 16px;
      display: flex;
      justify-content: center;
      align-items: center
    }

    .footer-wrap img {
      max-height: 48px;
      width: auto
    }

    /* ===== Modal (unchanged) ===== */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      z-index: 9999;
    }

    .modal .inner {
      width: 90%;
      max-width: 1000px;
      height: 85vh;
      margin: 3% auto;
      background: #fff;
      border-radius: 10px;
      padding: 8px;
    }

    .close {
      float: right;
      cursor: pointer;
      font-size: 20px;
      color: #333;
      padding: 6px;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="header-wrap">
      <div class="header-center">
        <img class="header-logo" src="/assets/citylogo.png" alt="City of Koronadal Logo">
        <div class="brand-block">
          <a href="https://koronadal.gov.ph" target="_blank" rel="noopener">CITY OF KORONADAL</a>
          <div class="brand-sub">
            <a href="https://www.facebook.com/profile.php?id=100093335296692" target="_blank" rel="noopener">
              Iskolar ng Koronadal - Kabugwason Paglaum Program
            </a>
          </div>
        </div>
        <img class="header-logo" src="/assets/iskologo.png" alt="Isko-KPP Logo">
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main>
    <div class="container">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <h1>Scholar Folder</h1>
        <a href="javascript:history.back()" class="btn small">Back</a>
      </div>

      <div id="scholarMeta" class="meta">Loading scholar...</div>

      <div class="tabs" id="folderTabs">
        <div class="tab active" data-target="all">All</div>
        <div class="tab" data-target="coe">Certificate of Enrollment/Registration</div>
        <div class="tab" data-target="scanned-grades">Scanned Grades</div>
        <div class="tab" data-target="soa">Statement of Accounts</div>
        <div class="tab" data-target="others">Others</div>
      </div>

      <div id="contentArea" style="overflow:auto;">
        <div id="all" class="folderSection">
          <h2>All Documents</h2>
          <ul id="docsAll" class="docs"></ul>
        </div>

        <div id="scanned-grades" class="folderSection" style="display:none">
          <h2>Scanned Grades</h2>
          <ul id="docsGrades" class="docs"></ul>
        </div>

        <div id="soa" class="folderSection" style="display:none">
          <h2>Statement of Account</h2>
          <ul id="docsSoa" class="docs"></ul>
        </div>

        <div id="coe" class="folderSection" style="display:none">
          <h2>Certificate of Enrollment</h2>
          <ul id="docsCoe" class="docs"></ul>
        </div>

        <div id="others" class="folderSection" style="display:none">
          <h2>Others</h2>
          <ul id="docsOthers" class="docs"></ul>
        </div>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="footer-wrap">
      <img src="/assets/footer.png" alt="Footer Graphic">
    </div>
  </footer>

  <!-- Preview Modal -->
  <div id="previewModal" class="modal">
    <div class="inner">
      <span id="closePreview" class="close">&times;</span>
      <iframe id="previewFrame" src="" style="width:100%; height:calc(100% - 30px); border:none;"></iframe>
    </div>
  </div>

  <script>

    // Keep All first and Others last; sort the middle ones by label
    (function alphabetizeTabs() {
      const container = document.getElementById('folderTabs');
      const tabs = Array.from(container.querySelectorAll('.tab'));

      const first = tabs.find(t => t.dataset.target === 'all');
      const last = tabs.find(t => t.dataset.target === 'others');
      const middle = tabs.filter(t => t !== first && t !== last);

      middle.sort((a, b) =>
        a.textContent.trim().localeCompare(b.textContent.trim(), undefined, { sensitivity: 'base' })
      );

      container.innerHTML = '';
      if (first) container.appendChild(first);
      middle.forEach(t => container.appendChild(t));
      if (last) container.appendChild(last);
    })();

    (async function () {
      /* -------------------- helpers -------------------- */
      function qs(name) { return new URLSearchParams(window.location.search).get(name); }
      function show(selector) {
        document.querySelectorAll('.folderSection').forEach(el => el.style.display = 'none');
        document.getElementById(selector).style.display = 'block';
      }
      function groupByType(doc) {
        const t = (doc.docType || "").toLowerCase().replace(/\s+/g, ' ').trim();

        // grades
        if (t.includes('grade')) return 'scanned-grades';

        // statement of account(s) or SOA
        if (t === 'soa' || /statement of account(s)?/.test(t)) return 'soa';

        // certificate of enrollment/registration | COE
        if (/(certificate.*(enrollment|registration)|\bcoe\b)/.test(t)) return 'coe';

        return 'others';
      }

      function fileUrl(bucket, id) { return (bucket && id) ? `/files/${bucket}/${id}` : null; }
      function resolveDocUrl(d) { return d.fileUrl || fileUrl(d.bucket, d.fileId) || d.filePath || null; }
      function resolveGradeAttachmentUrl(g) { return fileUrl(g.attachmentBucket, g.attachmentId) || g.attachment || null; }

      /* -------------------- UI els -------------------- */
      const scholarMeta = document.getElementById('scholarMeta');
      const docsAll = document.getElementById('docsAll');
      const docsGrades = document.getElementById('docsGrades');
      const docsSoa = document.getElementById('docsSoa');
      const docsCoe = document.getElementById('docsCoe');
      const docsOthers = document.getElementById('docsOthers');

      /* -------------------- guards -------------------- */
      const scholarId = qs('scholarId');
      if (!scholarId) {
        scholarMeta.textContent = 'No scholar selected. Go back and choose a scholar.';
        return;
      }

      /* -------------------- tabs -------------------- */
      document.getElementById('folderTabs').addEventListener('click', (e) => {
        const t = e.target.closest('.tab'); if (!t) return;
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        t.classList.add('active'); show(t.dataset.target);
      });

      /* -------------------- fetchers -------------------- */
      async function fetchScholarInfo() {
        try {
          const r = await fetch(`/api/scholars/${scholarId}`, { credentials: 'include' });
          if (!r.ok) throw 0;
          return await r.json();
        } catch {
          try {
            const r2 = await fetch('/api/verified-scholars', { credentials: 'include' });
            const list = await r2.json();
            return list.find(x => x._id === scholarId) || null;
          } catch { return null; }
        }
      }

      async function fetchScholarDocs() {
        try {
          let r = await fetch(`/api/admin/scholars/${scholarId}/documents`, { credentials: 'include' });
          if (!r.ok) {
            const all = await (await fetch('/api/admin/documents', { credentials: 'include' })).json();
            return all
              .filter(d => {
                const sameScholar = d.scholar && d.scholar._id
                  ? d.scholar._id === scholarId
                  : String(d.scholar) === String(scholarId);
                const statusNorm = String(d.status || '').trim().toLowerCase();
                return sameScholar && statusNorm === 'accepted';
              })
              .map(d => ({ ...d, url: resolveDocUrl(d) }));
          }
          const list = await r.json();
          return list
            .filter(d => String(d.status || '').trim().toLowerCase() === 'accepted')
            .map(d => ({ ...d, url: resolveDocUrl(d) }));
        } catch (err) {
          console.error('Error fetching scholar docs:', err);
          return [];
        }
      }

      async function fetchScholarGrades() {
        try {
          const r = await fetch(`/api/admin/grades/${scholarId}`, { credentials: 'include' });
          if (!r.ok) return [];
          const list = await r.json();
          return list.map(g => ({
            ...g,
            _url: (g.attachmentBucket && g.attachmentId) ? `/files/${g.attachmentBucket}/${g.attachmentId}` : (g.attachment || null),
            _statusNorm: String(g.status || '').trim().toLowerCase()
          }));
        } catch (err) {
          console.error('Error fetching grades:', err);
          return [];
        }
      }

      /* -------------------- render -------------------- */
      function addDocToList(listEl, doc) {
        const li = document.createElement('li');
        const fileLabel = doc.docType || (doc.url ? decodeURIComponent(doc.url.split('/').pop()) : 'File');
        const date = (doc.dateSubmitted || doc.createdAt)
          ? new Date(doc.dateSubmitted || doc.createdAt).toLocaleDateString()
          : '';
        const href = doc.url || '';

        li.innerHTML = `
          <div>
            <strong>${fileLabel}</strong>
            <div class="small">${date}</div>
          </div>
          <div>
            ${href ? `<a href="#" class="preview" data-file="${href}"><i class="fa fa-eye"></i> Preview</a>` : ''}
            ${href ? `&nbsp;<a href="${href}" target="_blank" class="small">Open</a>` : ''}
          </div>
        `;
        listEl.appendChild(li);
      } function addDocToList(listEl, doc) {
        const li = document.createElement('li');

        const isGrade = !!doc._isGrade; // <— flag we’ll set for accepted grades
        const fileLabel = isGrade
          ? 'Scanned Grades'
          : (doc.docType || (doc.url ? decodeURIComponent(doc.url.split('/').pop()) : 'File'));

        const dateStr = (doc.dateSubmitted || doc.createdAt)
          ? new Date(doc.dateSubmitted || doc.createdAt).toLocaleDateString()
          : '';

        const href = doc.url || '';

        // Build the metadata line (Semester + optional SY/Term)
        const metaPieces = [];
        if (isGrade) {
          if (doc.semester) metaPieces.push(doc.semester);
          if (doc.schoolYear) metaPieces.push(doc.schoolYear);
          if (doc.academicTerm) metaPieces.push(doc.academicTerm); // e.g., Final Grades
        }
        const metaLine = metaPieces.length ? `<div class="small">${metaPieces.join(' • ')}</div>` : '';

        li.innerHTML = `
    <div>
      <strong>${fileLabel}</strong>
      ${metaLine}
      <div class="small">${dateStr}</div>
    </div>
    <div>
      ${href ? `<a href="#" class="preview" data-file="${href}"><i class="fa fa-eye"></i> Preview</a>` : ''}
      ${href ? `&nbsp;<a href="${href}" target="_blank" class="small">Open</a>` : ''}
    </div>
  `;
        listEl.appendChild(li);
      }

      const scholar = await fetchScholarInfo();
      if (!scholar) {
        scholarMeta.textContent = 'Scholar not found or you are not authorized to view this. (Make sure you are logged in as admin.)';
        return;
      }
      scholarMeta.innerHTML = `<strong>${scholar.fullname}</strong> <span class="small"> • Batch: ${scholar.batchYear || 'N/A'} • ${scholar.email || ''}</span>`;

      const docs = await fetchScholarDocs();
      const grades = await fetchScholarGrades();

      grades.forEach(g => {
        if (g._statusNorm === 'accepted' && g._url) {
          docs.push({
            docType: 'Scanned Grades',
            url: g._url,
            dateSubmitted: g.dateSubmitted || g.createdAt,
            // NEW: carry semester/SY/term so the UI can show them
            _isGrade: true,
            semester: g.semester ?? '',
            schoolYear: g.schoolYear ?? '',
            academicTerm: g.academicTerm ?? ''  // e.g., Preliminary/Mid-Semester/Final Grades
          });
        }
      });



      docs.forEach(doc => {
        const entry = { ...doc, url: doc.url || resolveDocUrl(doc) };
        addDocToList(docsAll, entry);
        const group = groupByType(entry);
        if (group === 'scanned-grades') addDocToList(docsGrades, entry);
        else if (group === 'soa') addDocToList(docsSoa, entry);
        else if (group === 'coe') addDocToList(docsCoe, entry);
        else addDocToList(docsOthers, entry);
      });

      /* -------------------- preview modal -------------------- */
      document.body.addEventListener('click', (e) => {
        const a = e.target.closest('a.preview');
        if (!a) return;
        e.preventDefault();
        const href = a.dataset.file;
        if (!href) return;
        document.getElementById('previewFrame').src = href;
        document.getElementById('previewModal').style.display = 'block';
      });

      document.getElementById('closePreview').onclick = () => {
        document.getElementById('previewFrame').src = '';
        document.getElementById('previewModal').style.display = 'none';
      };
    })();
  </script>
</body>

</html>