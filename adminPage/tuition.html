<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tuition Tracker</title>
  <style>
    :root{
      --maroon:#800000;
      --maroon-dark:#5a0000;
      --gold:#D4A017;
    }
    *{ box-sizing:border-box }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      font-family: Arial, Helvetica, sans-serif;
      background: url('/assets/iskolarbg.png') center/cover no-repeat fixed;
    }

    /* ===== HEADER ===== */
    .site-header{ background:var(--maroon); border-bottom:2px solid var(--maroon-dark) }
    .header-wrap{ max-width:1200px; margin:0 auto; padding:10px 16px; display:flex; justify-content:center; align-items:center }
    .header-center{ display:flex; align-items:center; gap:18px }
    .header-logo{ height:64px; width:auto }
    .brand-block{ display:flex; flex-direction:column; align-items:center; text-align:center; color:#fff }
    .brand-block > a{ color:#fff; font-weight:800; font-size:24px; letter-spacing:.5px; text-decoration:none; transition:color .25s ease }
    .brand-block > a:hover{ color:var(--gold) }
    .brand-sub{ margin-top:4px; font-size:14px; font-weight:600 }
    .brand-sub a{ color:#fff; text-decoration:none; transition:color .25s ease }
    .brand-sub a:hover{ color:var(--gold) }
    @media (max-width:640px){ .header-logo{height:48px} .brand-block > a{font-size:20px} .brand-sub{font-size:12px} }

    /* ===== MAIN ===== */
    main{ flex:1; display:flex; justify-content:center; align-items:flex-start; padding:20px }
    .container{
      width:95%; max-width:1200px;
      background: rgba(255,255,255,.9);
      padding:20px; border-radius:12px;
      overflow-y:auto; max-height: calc(100vh - 180px);
      box-shadow:0 4px 12px rgba(0,0,0,.2);
    }

    h2{ color: var(--maroon); margin: 0 0 10px }

    /* Non-blocking status banner (no popups on load) */
    .status{ display:none; margin:0 0 12px; padding:10px 12px; border-radius:8px; font-weight:600 }
    .status.show{ display:block }
    .status.success{ background:#e8f5e9; color:#1b5e20; border:1px solid #c8e6c9 }
    .status.error{ background:#ffebee; color:#b71c1c; border:1px solid #ffcdd2 }

    .controls{ display:flex; gap:10px; margin-bottom:10px }
    input, select{
      padding:8px 12px; border:1px solid #ccc; border-radius:6px; font-size:14px; background:#fff;
    }

    table{ width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden }
    th, td{ padding:12px; border-bottom:1px solid #ddd; text-align:left }
    thead{ background: var(--maroon); color:#fff }
    tr:hover{ background: rgba(128,0,0,.08) }

    .btn{
      background: var(--maroon); color:#fff; border:0; border-radius:6px; padding:6px 10px; cursor:pointer;
    }
    .btn:hover{ background:#a00000 }

    .reset-btn{
      background: var(--maroon); color:#fff; border:0; border-radius:8px; padding:8px 14px; font-weight:600; letter-spacing:.2px; cursor:pointer;
      box-shadow:0 2px 6px rgba(211,47,47,.25);
      transition:transform .08s ease, box-shadow .2s ease, background .2s ease;
    }
    .reset-btn:active{ transform: translateY(1px); box-shadow:0 2px 6px rgba(183,28,28,.35) }
    .reset-btn::before{ content:"↺"; margin-right:8px; font-weight:700 }

    /* ===== MODALS ===== (only open on click) */
    .modal{
      display:none; position:fixed; z-index:1000; inset:0;
      background: rgba(0,0,0,.5); justify-content:center; align-items:center; padding:20px;
    }
    .modal-content{
      background:#fff; padding:20px; border-radius:8px; width:300px; text-align:center;
      box-shadow:0 4px 10px rgba(0,0,0,.3);
    }
    .modal-content input{ width:80%; padding:8px; margin:10px 0; border-radius:5px; border:1px solid #ccc }
    .modal-buttons{ display:flex; justify-content:space-around }
    .cancel-btn{ background:#ccc; color:#000; border:0; padding:6px 12px; border-radius:6px; cursor:pointer }
    .cancel-btn:hover{ background:#bbb }

    /* ===== FOOTER ===== */
    .site-footer{ background:#fff; border-top:1px solid #000; outline:1px solid #000; outline-offset:-1px }
    .footer-wrap{ max-width:1200px; margin:0 auto; padding:14px 16px; display:flex; justify-content:center; align-items:center }
    .footer-wrap img{ max-height:48px; width:auto }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="header-wrap">
      <div class="header-center">
        <img class="header-logo" src="/assets/citylogo.png" alt="City of Koronadal Logo">
        <div class="brand-block">
          <a href="https://koronadal.gov.ph" target="_blank" rel="noopener">CITY OF KORONADAL</a>
          <div class="brand-sub">
            <a href="https://www.facebook.com/profile.php?id=100093335296692" target="_blank" rel="noopener">
              Iskolar ng Koronadal - Kabugwason Paglaum Program
            </a>
          </div>
        </div>
        <img class="header-logo" src="/assets/iskologo.png" alt="Isko-KPP Logo">
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main>
    <div class="container">
      <!-- non-blocking status messages -->
      <div id="status" class="status" role="status" aria-live="polite"></div>

      <h2>Tuition Tracker</h2>

      <div class="controls">
        <input type="text" id="searchInput" placeholder="Search scholar...">
        <select id="batchFilter"></select>
      </div>

      <table>
        <thead>
          <tr>
            <th>Scholar</th>
            <th>Batch</th>
            <th>Allotted Budget (₱)</th>
            <th>Balance (₱)</th>
            <th>Remaining Budget (₱)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="expenseTable"></tbody>
      </table>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="footer-wrap">
      <img src="/assets/footer.png" alt="Footer Graphic">
    </div>
  </footer>

  <!-- Set Budget Modal -->
  <div id="budgetModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="budgetTitle">
      <h3 id="budgetTitle">Set Allotted Budget</h3>
      <input type="number" id="budgetInput" placeholder="Enter amount" />
      <div class="modal-buttons">
        <button id="saveBudgetBtn" class="btn">Save</button>
        <button id="cancelBudgetBtn" class="cancel-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Pay Modal -->
  <div id="payModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="payTitle">
      <h3 id="payTitle">Pay Tuition</h3>
      <input type="number" id="payInput" placeholder="Enter amount to pay" />
      <div class="modal-buttons">
        <button id="savePayBtn" class="btn">Save</button>
        <button id="cancelPayBtn" class="cancel-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Reimburse Modal -->
<div id="reimbModal" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="reimbTitle">
    <h3 id="reimbTitle">Add Reimbursement</h3>
    <input type="number" id="reimbInput" placeholder="Enter amount to reimburse" />
    <div class="modal-buttons">
      <button id="saveReimbBtn" class="btn">Save</button>
      <button id="cancelReimbBtn" class="cancel-btn">Cancel</button>
    </div>
  </div>
</div>

<!-- Tuition History Modal -->
<div id="tuitionHistoryModal" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="tuitionHistoryTitle" style="width:520px; text-align:left">
    <h3 id="tuitionHistoryTitle" style="margin-bottom:12px;color:#fff;background:#800000;padding:10px;border-radius:6px">
      Tuition History
    </h3>
    <div style="max-height:360px; overflow:auto; border:1px solid #eee; border-radius:8px">
      <table style="width:100%; border-collapse:collapse">
        <thead style="position:sticky; top:0; background:#800000; color:#fff; z-index:1">
          <tr>
            <th style="padding:10px; border-bottom:1px solid #ddd; text-align:left">Date</th>
            <th style="padding:10px; border-bottom:1px solid #ddd; text-align:left">Action</th>
            <th style="padding:10px; border-bottom:1px solid #ddd; text-align:right">Amount (₱)</th>
            <th style="padding:10px; border-bottom:1px solid #ddd; text-align:right">Remaining (₱)</th>
          </tr>
        </thead>
        <tbody id="tuitionHistoryBody"></tbody>
      </table>
    </div>
    <div class="modal-buttons" style="margin-top:12px; justify-content:flex-end">
      <button id="closeTuitionHistoryBtn" class="cancel-btn">Close</button>
    </div>
  </div>
</div>



  <script>
    // ===== Elements
    const expenseTable = document.getElementById("expenseTable");
    const searchInput  = document.getElementById("searchInput");
    const batchFilter  = document.getElementById("batchFilter");
    const statusEl     = document.getElementById("status");

    const budgetModal  = document.getElementById("budgetModal");
    const payModal     = document.getElementById("payModal");

    const budgetInput  = document.getElementById("budgetInput");
    const payInput     = document.getElementById("payInput");

    const saveBudgetBtn = document.getElementById("saveBudgetBtn");
    const savePayBtn    = document.getElementById("savePayBtn");

    const cancelBudgetBtn = document.getElementById("cancelBudgetBtn");
    const cancelPayBtn    = document.getElementById("cancelPayBtn");

    const reimbModal   = document.getElementById("reimbModal");
    const reimbInput   = document.getElementById("reimbInput");
    const saveReimbBtn = document.getElementById("saveReimbBtn");
    const cancelReimbBtn = document.getElementById("cancelReimbBtn");

    // helper for remaining budget
    const rem = (b = 0, p = 0, r = 0) => b - (p + r);

    // ===== State
    let currentScholarId = null;
    let allRows = [];

    // ===== Helpers (non-blocking)
    function notify(msg, type='success', timeout=3000){
      statusEl.textContent = msg;
      statusEl.className = `status show ${type}`;
      clearTimeout(statusEl._t);
      statusEl._t = setTimeout(()=>{ statusEl.className='status'; statusEl.textContent=''; }, timeout);
    }
    function openModal(el){ el.style.display='flex'; el.setAttribute('aria-hidden','false'); }
    function closeModal(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); }

    // ===== Load data (no popups on load)
    async function loadScholars() {
      try {
        const r = await fetch("/api/tuition", { credentials: "include" });
        if (!r.ok) {
          const t = await r.text().catch(()=> "");
          notify(`Failed to load tuition tracker (HTTP ${r.status})${t?`: ${t}`:''}`, 'error', 5000);
          return;
        }
        allRows = await r.json();
        populateBatchFilter(allRows);
        renderTable(allRows);
      } catch (err) {
        console.error("Failed to load tuition tracker:", err);
        notify("Network error while loading data.", 'error', 5000);
      }
    }

    function populateBatchFilter(data) {
      const years = [...new Set(data.map(s => s.batchYear).filter(Boolean))].sort();
      batchFilter.innerHTML = '<option value="">All Batches</option>';
      years.forEach(y => {
        const opt = document.createElement("option");
        opt.value = y; opt.textContent = "Batch " + y; batchFilter.appendChild(opt);
      });
    }

    function renderTable(rows) {
  expenseTable.innerHTML = "";
  if (!rows.length) {
    expenseTable.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#666;">No scholars found</td></tr>`;
    return;
  }

  rows.forEach(s => {
    // Prefer the API's computed remaining; fallback if absent
     const remaining = Number.isFinite(s.remaining)
   ? s.remaining
   : ((s.allottedBudget || 0) - ((s.totalPaid || 0) + (s.totalReimbursed || 0)));

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
  <button class="history-btn" data-id="${s._id}" title="View tuition history"
    style="background:none;border:0;color:#0645ad;text-decoration:underline;cursor:pointer;padding:0">
    ${s.fullname}
  </button>
</td>

      <td>${s.batchYear || '-'}</td>

      <td>
        <button class="btn set-budget-btn" data-id="${s._id}" data-budget="${s.allottedBudget || 0}">
          Set Budget
        </button>
      </td>

      <td>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          <button class="btn pay-btn" data-id="${s._id}">Pay</button>
          <button class="btn reimburse-btn" data-id="${s._id}">Reimburse</button> <!-- 👈 NEW -->
        </div>
      </td>

      <td style="font-weight:bold; color:${remaining < 0 ? 'red' : 'green'};">₱ ${remaining.toFixed(2)}</td>
      <td><button class="reset-btn" data-id="${s._id}">Reset</button></td>
    `;
    expenseTable.appendChild(tr);
  });
}


    function applyFilters() {
      const q  = (searchInput.value || "").toLowerCase();
      const by = batchFilter.value;
      const filtered = allRows.filter(s => {
        const okQ = (s.fullname || "").toLowerCase().includes(q);
        const okB = by === "" || String(s.batchYear) === by;
        return okQ && okB;
      });
      renderTable(filtered);
    }

    // ===== Actions
    expenseTable.addEventListener("click", async (e) => {
      const btn = e.target.closest("button"); if (!btn) return;

      if (btn.classList.contains("set-budget-btn")) {
        currentScholarId = btn.dataset.id;
        budgetInput.value = btn.dataset.budget || 0;
        openModal(budgetModal);
        return;
      }

      if (btn.classList.contains("pay-btn")) {
        currentScholarId = btn.dataset.id;
        payInput.value = "";
        openModal(payModal);
        return;
      }

      if (btn.classList.contains("reimburse-btn")) {
        currentScholarId = btn.dataset.id;
        reimbInput.value = "";
        openModal(reimbModal);
        return;
      }

      if (btn.classList.contains("reset-btn")) {
        const userId = btn.dataset.id;
        if (!confirm("Reset this scholar's Tuition tracker to zero?")) return;
        try {
          const r = await fetch(`/api/tuition/${userId}/reset`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            credentials: "include"
          });
          if (r.ok) {
            notify("Reset successful.");
            loadScholars();
          } else {
            const t = await r.text().catch(()=> "");
            notify(`Failed to reset (HTTP ${r.status})${t?`: ${t}`:''}`, 'error', 5000);
          }
        } catch (err) {
          console.error(err);
          notify("Reset failed. Check console for details.", 'error', 5000);
        }
      }
    });

    saveBudgetBtn.addEventListener("click", async () => {
      const amount = Number(budgetInput.value);
      if (!currentScholarId || !Number.isFinite(amount) || amount < 0) {
        notify("Enter a non-negative number.", 'error', 3000);
        return;
      }
      try {
        const r = await fetch(`/api/tuition/${currentScholarId}/budget`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ allottedBudget: amount })
        });
        if (!r.ok) {
          const msg = await r.text().catch(()=> "");
          notify(`Failed to update budget (HTTP ${r.status})${msg?`: ${msg}`:''}`, 'error', 5000);
          return;
        }
        const { tracker } = await r.json();
        allRows = allRows.map(row =>
          row._id === currentScholarId
            ? {
              ...row,
              allottedBudget: tracker?.allottedBudget ?? amount,
              totalPaid: tracker?.totalPaid ?? row.totalPaid ?? 0,
              remaining:
                (tracker?.allottedBudget ?? amount) -
                ((tracker?.totalPaid ?? row.totalPaid ?? 0) +
                  (tracker?.totalReimbursed ?? row.totalReimbursed ?? 0))
            }
            : row
        );
        renderTable(allRows);
        closeModal(budgetModal);
        notify("Budget updated successfully.");
      } catch (err) {
        console.error(err);
        notify(`Budget update failed: ${err.message}`, 'error', 5000);
      }
    });

    savePayBtn.addEventListener("click", async () => {
      const v = Number(payInput.value);
      if (!currentScholarId || !Number.isFinite(v) || v <= 0) {
        notify("Enter a positive number.", 'error', 3000);
        return;
      }
      try {
        const r = await fetch(`/api/tuition/${currentScholarId}/pay`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ addAmount: v })
        });
        if (!r.ok) {
          const msg = await r.text().catch(()=> "");
          notify(`Failed to record payment (HTTP ${r.status})${msg?`: ${msg}`:''}`, 'error', 5000);
          return;
        }
        const { tracker } = await r.json();
        allRows = allRows.map(row =>
          row._id === currentScholarId
            ? {
              ...row,
              allottedBudget: tracker?.allottedBudget ?? row.allottedBudget ?? 0,
              totalPaid: tracker?.totalPaid ?? row.totalPaid ?? 0,
              totalReimbursed: tracker?.totalReimbursed ?? row.totalReimbursed ?? 0,
              remaining:
                tracker?.remaining ??
                ((tracker?.allottedBudget ?? row.allottedBudget ?? 0) -
                  ((tracker?.totalPaid ?? row.totalPaid ?? 0) +
                    (tracker?.totalReimbursed ?? row.totalReimbursed ?? 0)))
            }
            : row
        );
        renderTable(allRows);
        closeModal(payModal);
        notify("Payment saved.");
      } catch (err) {
        console.error(err);
        notify(`Payment failed: ${err.message}`, 'error', 5000);
      }
    });

    saveReimbBtn.addEventListener("click", async () => {
  const v = Number(reimbInput.value);
  if (!currentScholarId || !Number.isFinite(v) || v <= 0) {
    notify("Enter a positive number.", 'error', 3000);
    return;
  }
  try {
    const r = await fetch(`/api/tuition/${currentScholarId}/reimburse`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ addAmount: v })
    });
    if (!r.ok) {
      const msg = await r.text().catch(()=> "");
      notify(`Failed to record reimbursement (HTTP ${r.status})${msg?`: ${msg}`:''}`, 'error', 5000);
      return;
    }
    const { tracker } = await r.json();

    // Update local row
    allRows = allRows.map(row =>
      row._id === currentScholarId
        ? {
            ...row,
            allottedBudget: tracker?.allottedBudget ?? row.allottedBudget ?? 0,
            totalPaid: tracker?.totalPaid ?? row.totalPaid ?? 0,
            totalReimbursed: tracker?.totalReimbursed ?? row.totalReimbursed ?? 0,
            remaining: tracker?.remaining ?? row.remaining
          }
        : row
    );

    renderTable(allRows);
    closeModal(reimbModal);
    notify("Reimbursement saved.");
  } catch (err) {
    console.error(err);
    notify(`Reimbursement failed: ${err.message}`, 'error', 5000);
  }
});

// ===== History modal refs
const tuitionHistoryModal = document.getElementById("tuitionHistoryModal");
const tuitionHistoryBody  = document.getElementById("tuitionHistoryBody");
const closeTuitionHistoryBtn = document.getElementById("closeTuitionHistoryBtn");

function openTuitionHistory() {
  tuitionHistoryModal.style.display = "flex";
  tuitionHistoryModal.setAttribute('aria-hidden', 'false');
}
function closeTuitionHistory() {
  tuitionHistoryModal.style.display = "none";
  tuitionHistoryModal.setAttribute('aria-hidden', 'true');
}
closeTuitionHistoryBtn.addEventListener("click", closeTuitionHistory);
window.addEventListener("click", (e) => {
  if (e.target === tuitionHistoryModal) closeTuitionHistory();
});

function fmtMoney(n){ return (Number(n)||0).toLocaleString('en-PH', { minimumFractionDigits:2, maximumFractionDigits:2 }); }
function fmtDate(d){ try { return new Date(d).toLocaleString(); } catch { return d; } }

function renderTuitionHistory(rows){
  if(!rows.length){
    tuitionHistoryBody.innerHTML = `<tr><td colspan="4" style="padding:10px; text-align:center; color:#666">No history yet</td></tr>`;
    return;
  }
  tuitionHistoryBody.innerHTML = rows.map(h => `
    <tr>
      <td style="padding:8px 10px; border-bottom:1px solid #eee">${fmtDate(h.date)}</td>
      <td style="padding:8px 10px; border-bottom:1px solid #eee">${h.action}</td>
      <td style="padding:8px 10px; border-bottom:1px solid #eee; text-align:right">${fmtMoney(h.amount)}</td>
      <td style="padding:8px 10px; border-bottom:1px solid #eee; text-align:right">${fmtMoney(h.remaining)}</td>
    </tr>
  `).join("");
}

// Delegate clicks: open history when clicking scholar name
expenseTable.addEventListener("click", async (e) => {
  const btn = e.target.closest("button");
  if(!btn) return;

  if(btn.classList.contains("history-btn")){
    const userId = btn.dataset.id;
    try{
      const res = await fetch(`/api/tuition/${userId}/history`, { credentials:"include" });
      if(!res.ok){
        const t = await res.text().catch(()=> "");
        notify(`Failed to load history (HTTP ${res.status})${t?`: ${t}`:''}`, 'error', 5000);
        return;
      }
      const data = await res.json();
      renderTuitionHistory(data);
      openTuitionHistory();
    }catch(err){
      console.error("History fetch failed:", err);
      notify("Network error while loading history.", 'error', 5000);
    }
    return;
  }
});



    // Close modals
    cancelBudgetBtn.addEventListener("click", ()=> closeModal(budgetModal));
    cancelPayBtn.addEventListener("click", ()=> closeModal(payModal));
    cancelReimbBtn.addEventListener("click", ()=> closeModal(reimbModal));
    window.addEventListener("click", (e)=>{
      if(e.target === budgetModal) closeModal(budgetModal);
      if(e.target === payModal)    closeModal(payModal);
      if(e.target === reimbModal) closeModal(reimbModal);
    });

    // Filters
    searchInput.addEventListener("input", applyFilters);
    batchFilter.addEventListener("change", applyFilters);

    // Init (no alerts on load)
    window.addEventListener("DOMContentLoaded", loadScholars);
  </script>
</body>

</html>
