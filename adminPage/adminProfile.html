<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Profile</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: url('/assets/iskolarbg.png') center/cover no-repeat;
      font-family: Arial, sans-serif;
    }

    .profileContainer {
      width: 90%;
      max-width: 600px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      padding: 30px;
    }

    .profileContainer h2 {
      margin-bottom: 20px;
      text-align: center;
    }

    .profile-pic {
      text-align: center;
      margin-bottom: 20px;
    }

    .profile-pic img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #800000;
    }

    .profile-pic input {
      margin-top: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      display: block;
      width: 100%;
      padding: 10px;
      background: #800000;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 15px;
    }

    button:hover {
      background: #a00000;
    }

    .hint { color:#555; font-size: 12px; margin-top:6px; text-align:center; }
  </style>
</head>
<body>
  <div class="profileContainer">
    <h2>Edit Profile</h2>

    <form id="profileForm" enctype="multipart/form-data">
      <div class="profile-pic">
        <img id="preview" src="/assets/default-avatar.png" alt="Profile Picture">
        <input id="picInput" type="file" name="profilePic" accept="image/*" onchange="previewImage(event)">
        <div class="hint">Max ~5–10MB is typical; PNG/JPG recommended.</div>
      </div>

      <div class="form-group">
        <label for="fullname">Full Name</label>
        <input type="text" name="fullname" id="fullname" required>
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" name="email" id="email" required>
      </div>

      <button type="submit">Save Changes</button>
    </form>
  </div>

  <script>
    // Util: build a GridFS URL if API didn't send a ready-made profilePicUrl
    function fileUrl(bucket, id, { download = false } = {}) {
      if (!bucket || !id) return null;
      return download ? `/files/${bucket}/${id}/download` : `/files/${bucket}/${id}`;
    }

    // Show image preview immediately after choosing a file
    function previewImage(event) {
      const file = event.target.files?.[0];
      if (!file) return;

      // Guard: basic client-side size/type check (optional)
      const allowed = ['image/png','image/jpeg','image/webp','image/gif'];
      if (!allowed.includes(file.type)) {
        alert('Please select a PNG/JPG/WEBP/GIF image.');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function() {
        document.getElementById('preview').src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    async function loadProfile() {
      try {
        const res = await fetch('/api/users/me');
        if (res.status === 401) {
          // Not logged-in or token expired → go to login
          window.location.href = '/';
          return;
        }
        if (!res.ok) throw new Error('Failed to load profile');

        const user = await res.json();

        // Fill text fields
        document.getElementById('fullname').value = user.fullname || '';
        document.getElementById('email').value = user.email || '';

        // Determine profile picture URL
        // Prefer server-computed URL if provided
        let src = user.profilePicUrl || null;

        // Otherwise construct from bucket + id (GridFS)
        if (!src && user.profilePicBucket && user.profilePicId) {
          src = fileUrl(user.profilePicBucket, user.profilePicId);
        }

        // Fallback to legacy string path if you still have old records
        if (!src && user.profilePic) {
          src = user.profilePic;
        }

        // Apply with cache-buster so new uploads reflect immediately
        const img = document.getElementById('preview');
        img.src = src ? `${src}?v=${Date.now()}` : '/assets/default-avatar.png';
      } catch (err) {
        console.error(err);
        alert('Unable to load profile right now.');
      }
    }

    loadProfile();

    // Submit handler (PUT /api/users/me)
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      try {
        const res = await fetch('/api/users/me', {
          method: 'PUT',
          body: formData
        });

        if (res.status === 401) {
          window.location.href = '/';
          return;
        }

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data?.msg || 'Failed to update profile');
        }

        alert(data.msg || 'Profile updated!');

        // Update preview with returned URL (if provided)
        const nextSrc =
          data.profilePicUrl ||
          (data.user?.profilePicBucket && data.user?.profilePicId
            ? fileUrl(data.user.profilePicBucket, data.user.profilePicId)
            : null);

        if (nextSrc) {
          // cache-buster to ensure we see the fresh file
          document.getElementById('preview').src = `${nextSrc}?v=${Date.now()}`;
        }

        // Clear the file input so accidental re-submit won't re-upload
        document.getElementById('picInput').value = '';

      } catch (err) {
        console.error(err);
        alert(err.message || 'Update failed.');
      }
    });
  </script>
</body>
</html>
