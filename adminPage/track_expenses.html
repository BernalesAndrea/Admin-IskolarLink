<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scholar Expenses Tracker</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      background-image: url('/assets/iskolarbg.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      font-family: Arial, Helvetica, sans-serif;
      color: #000;
      overflow: hidden;
      /*Prevent page scroll */
    }

    /* Container*/
    .container {
      width: 95%;
      max-width: 1200px;
      margin-top: 40px;
      max-height: 90vh;
      /* limit height */
      overflow-y: auto;
      /* enable vertical scroll inside */
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* Header bar */
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 20px;
    }

    .header-bar h2 {
      margin: 0;
      font-size: 26px;
      color: black;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .controls input,
    .controls select {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    thead {
      background: #800000;
      color: #fff;
    }

    th,
    td {
      padding: 14px 16px;
      text-align: left;
      font-size: 15px;
    }

    th {
      font-weight: bold;
      letter-spacing: 0.5px;
    }

    tbody tr {
      border-bottom: 1px solid #ddd;
      transition: background 0.2s ease;
    }

    tbody tr:hover {
      background: rgba(128, 0, 0, 0.08);
    }

    td {
      color: #333;
    }

    .actions {
      cursor: pointer;
      font-size: 20px;
      padding: 6px 10px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .actions:hover {
      background: rgba(128, 0, 0, 0.1);
    }

    /* Popup Menu */
    .menu {
      display: none;
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 10;
      overflow: hidden;
    }

    .menu button {
      display: block;
      width: 100%;
      border: none;
      background: none;
      padding: 10px 14px;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
    }

    .menu button:hover {
      background: #800000;
      color: #fff;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      width: auto;
      /* Let it adjust automatically */
      max-width: 90%;
      /* Responsive for smaller screens */
      display: inline-block;
      /* Shrinks to fit content */
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      animation: fadeIn 0.3s ease;
      max-height: 80vh;
      /* Prevent it from going off-screen */
      overflow-y: auto;
      /* Scroll if content is too tall */
    }


    .modal-content h3 {
      margin-bottom: 20px;
      color: #800000;
    }

    .modal-content label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
      text-align: left;
    }

    .modal-content select,
    .modal-content input {
      width: 95%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }

    .modal-content button {
      padding: 10px 16px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .save-btn {
      background: #800000;
      color: white;
      font-weight: bold;
    }

    .cancel-btn {
      background: #444;
      color: white;
    }

    .save-btn:hover {
      background: #660000;
    }

    .cancel-btn:hover {
      background: #222;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>

  <!-- Container -->
  <div class="container">
    <!-- Header bar -->
    <div class="header-bar">
      <h2>Scholar Expenses Tracker</h2>
      <div class="controls">
        <input type="text" id="searchInput" placeholder="Search scholar...">
        <select id="batchFilter">
          <option value="">All Batches</option>
          <option value="2020">Batch 2020</option>
          <option value="2021">Batch 2021</option>
          <option value="2022">Batch 2022</option>
          <option value="2023">Batch 2023</option>
        </select>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Name of Scholar</th>
          <th>Batch Number</th>
          <th>Date Modified</th>
          <th>Tuition</th>
          <th>Book Allowance</th>
          <th>Monthly Allowance</th>
          <th>Total Spent</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="expenseTable">
        <!-- Verified scholars will be loaded here -->
      </tbody>
    </table>
  </div>

  <!-- Popup Menu -->
  <div class="menu" id="menu">
    <button id="addBtn">âž• Add Amount</button>
    <button id="subBtn">âž– Subtract Amount</button>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 id="modalTitle">Enter Amount</h3>
      <label for="category">Category:</label>
      <select id="category">
        <option value="tuition">Tuition</option>
        <option value="book">Book Allowance</option>
        <option value="allowance">Monthly Allowance</option>
      </select>
      <input type="number" id="amountInput" placeholder="Enter amount">
      <br>
      <button class="save-btn" id="saveBtn">Save</button>
      <button class="cancel-btn" id="cancelBtn">Cancel</button>
    </div>
  </div>

  <div class="modal" id="historyModal">
  <div class="modal-content">
    <h3>Expense History</h3>
    <div class="table-container">
      <table id="historyTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Action</th>
            <th>Category</th>
            <th>Amount</th>
            <th>Total After</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button class="cancel-btn" id="closeHistory">Close</button>
  </div>
</div>



  <script>
    const menu = document.getElementById("menu");
    const modal = document.getElementById("modal");
    const saveBtn = document.getElementById("saveBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const amountInput = document.getElementById("amountInput");
    const modalTitle = document.getElementById("modalTitle");
    const categorySelect = document.getElementById("category");
    const expenseTable = document.getElementById("expenseTable");
    const searchInput = document.getElementById("searchInput");
    const batchFilter = document.getElementById("batchFilter");

    let currentRow = null;
    let actionType = null;
    let allScholars = [];

    function formatDate(date) {
      return date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric"
      });
    }

    // âœ… Fetch verified scholars + expenses
    async function loadVerifiedScholars() {
      try {
        const res = await fetch("/api/scholars-with-expenses");
        const scholars = await res.json();
        allScholars = scholars;

        // ðŸ”¹ Generate unique batch years
        const batchYears = [...new Set(scholars.map(s => s.batchYear).filter(Boolean))].sort();

        // ðŸ”¹ Populate filter dropdown
        batchFilter.innerHTML = `<option value="">All Batches</option>`;
        batchYears.forEach(year => {
          const opt = document.createElement("option");
          opt.value = year;
          opt.textContent = `Batch ${year}`;
          batchFilter.appendChild(opt);
        });

        renderTable(scholars);
      } catch (err) {
        console.error("Error loading scholars with expenses:", err);
      }
    }

    // âœ… Render table
    function renderTable(data) {
      expenseTable.innerHTML = "";
      data.forEach((scholar) => {
        const row = document.createElement("tr");
        row.setAttribute("data-id", scholar._id);

        row.innerHTML = `
      <td class="scholar-name" style="cursor:pointer; color:#800000; text-decoration:underline;">
        ${scholar.fullname}
      </td>
      <td>${scholar.batchYear || "-"}</td>
      <td>${scholar.dateModified ? formatDate(new Date(scholar.dateModified)) : "-"}</td>
      <td class="tuition">${(scholar.tuition || 0).toFixed(2)}</td>
      <td class="book">${(scholar.bookAllowance || 0).toFixed(2)}</td>
      <td class="allowance">${(scholar.monthlyAllowance || 0).toFixed(2)}</td>
      <td class="total">${(scholar.totalSpent || 0).toFixed(2)}</td>
      <td><span class="actions">â‹®</span></td>
    `;
        expenseTable.appendChild(row);
      });
      attachActionEvents();
    }


    // âœ… Search + Filter
    function applyFilters() {
      const searchValue = searchInput.value.toLowerCase();
      const batchValue = batchFilter.value;

      const filtered = allScholars.filter(s => {
        const matchesSearch = s.fullname.toLowerCase().includes(searchValue);
        const matchesBatch = batchValue === "" || String(s.batchYear) === batchValue;
        return matchesSearch && matchesBatch;
      });

      renderTable(filtered);
    }

    searchInput.addEventListener("input", applyFilters);
    batchFilter.addEventListener("change", applyFilters);

    // âœ… Attach menu events
    function attachActionEvents() {
      document.querySelectorAll(".actions").forEach(action => {
        action.addEventListener("click", (e) => {
          const rect = e.target.getBoundingClientRect();
          menu.style.top = rect.bottom + "px";
          menu.style.left = rect.left + "px";
          menu.style.display = "block";
          currentRow = e.target.closest("tr");
        });
      });
    }

    // Close menu
    document.addEventListener("click", (e) => {
      if (!menu.contains(e.target) && !e.target.classList.contains("actions")) {
        menu.style.display = "none";
      }
    });

    document.getElementById("addBtn").addEventListener("click", () => {
      actionType = "add";
      modalTitle.textContent = "Add Amount";
      amountInput.value = "";
      modal.style.display = "flex";
      menu.style.display = "none";
    });

    document.getElementById("subBtn").addEventListener("click", () => {
      actionType = "subtract";
      modalTitle.textContent = "Subtract Amount";
      amountInput.value = "";
      modal.style.display = "flex";
      menu.style.display = "none";
    });

    cancelBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });

    saveBtn.addEventListener("click", async () => {
      if (!currentRow) return;

      const category = categorySelect.value;
      const cell = currentRow.querySelector("." + category);
      let currentAmount = parseFloat(cell.textContent) || 0;
      let value = parseFloat(amountInput.value);

      if (isNaN(value) || value <= 0) return;

      // Update cell based on action
      if (actionType === "add") {
        currentAmount += value;
      } else if (actionType === "subtract") {
        currentAmount -= value;
        if (currentAmount < 0) currentAmount = 0;
      }

      // Update the selected category cell
      cell.textContent = currentAmount.toFixed(2);

      // âœ… Recalculate totals after update
      const tuitionVal = parseFloat(currentRow.querySelector(".tuition").textContent) || 0;
      const bookVal = parseFloat(currentRow.querySelector(".book").textContent) || 0;
      const allowanceVal = parseFloat(currentRow.querySelector(".allowance").textContent) || 0;
      const total = tuitionVal + bookVal + allowanceVal;
      currentRow.querySelector(".total").textContent = total.toFixed(2);

      // Update dateModified in table
      const now = new Date();
      currentRow.cells[2].textContent = formatDate(now);

      // ðŸ”¥ Send updated amounts to backend
      const scholarId = currentRow.getAttribute("data-id");
      try {
        const res = await fetch(`/api/expenses/${scholarId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            tuition: tuitionVal,
            bookAllowance: bookVal,
            monthlyAllowance: allowanceVal,
            action: actionType,
            category,
            amount: value,
          })
        });

        if (!res.ok) {
          const errData = await res.json();
          console.error("Error saving expense:", errData);
          alert("Failed to save expense. Check console for details.");
        }
      } catch (err) {
        console.error("Error saving expense:", err);
        alert("Error connecting to server. Expense not saved.");
      }

      // Close modal
      modal.style.display = "none";
    });

    // Open history when clicking on scholar name
    expenseTable.addEventListener("click", (e) => {
      const cell = e.target.closest("td.scholar-name");
      if (!cell) return;

      const row = cell.closest("tr");
      const scholarId = row.getAttribute("data-id");
      openHistoryModal(scholarId);
    });


    function openHistoryModal(scholarId) {
      const modal = document.getElementById("historyModal");
      const tbody = modal.querySelector("tbody");
      tbody.innerHTML = "";

      fetch(`/api/expenses/${scholarId}/history`)
        .then(res => res.json())
        .then(history => {
          if (!history || history.length === 0) {
            const row = document.createElement("tr");
            row.innerHTML = `<td colspan="5" style="text-align:center;">No history found</td>`;
            tbody.appendChild(row);
          } else {
            history.forEach(entry => {
              const row = document.createElement("tr");
              row.innerHTML = `
<td>${entry.date ? new Date(entry.date).toLocaleString() : "-"}</td>
<td>${entry.action || "-"}</td>
<td>${entry.category || "-"}</td>
<td>${entry.amount != null ? entry.amount.toFixed(2) : "0.00"}</td>
<td>${entry.newTotal != null ? entry.newTotal.toFixed(2) : "0.00"}</td>
`;
              tbody.appendChild(row);
            });
          }
        })
        .catch(err => console.error("Failed to fetch history:", err));

      modal.style.display = "flex";
    }


    // Close History Modal
    const closeHistoryBtn = document.getElementById("closeHistory");
    const historyModal = document.getElementById("historyModal");

    closeHistoryBtn.addEventListener("click", () => {
      historyModal.style.display = "none";
    });

    // Optional: also close modal if clicking outside the content
    historyModal.addEventListener("click", (e) => {
      if (e.target === historyModal) {
        historyModal.style.display = "none";
      }
    });


    // âœ… Call on page load
    window.addEventListener("DOMContentLoaded", loadVerifiedScholars);
  </script>
</body>

</html>